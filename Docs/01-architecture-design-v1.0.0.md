# 架构设计文档 v1.0.0

## 版本记录

| 版本 | 日期 | 变更类型 | 变更内容 |
|------|------|----------|----------|
| 1.0.0 | 2025-12-22 | 初始版本 | 创建架构设计文档，包含系统概述、核心架构、数据流设计、安全设计和性能优化策略 |

## 全局要求

**重要提醒：本文档遵循全局时间处理要求，任何涉及时间的操作必须先查询系统时间或使用MCP服务确认后方可执行。详细规范请参考 [00-global-requirements-v1.0.0.md](00-global-requirements-v1.0.0.md)**

## 系统概述

本系统是一个基于Electron的AI视频生成工作流管理平台，定位为中间件，不直接参与视频渲染，而是提供统一的工作流管理和物料管理功能。

## 核心架构

### 主进程架构

#### 项目管理器
- 项目创建、加载、保存
- 项目配置管理
- 小说项目模板系统
- 项目历史记录
- 分镜脚本管理

#### 物料管理器
- 角色资产一致性管理
- 分镜素材组织
- 场景物料分类
- 元数据维护与搜索
- 物料预览与匹配

#### 工作流配置器
- 轻量级工作流定义
- 模型调用链配置
- 参数模板管理
- 工作流预设市场
- 批处理配置

#### 插件系统
- 插件加载与卸载
- 插件生命周期管理
- 插件API标准化
- 插件市场集成
- 社区配方管理

#### 任务调度器
- 任务队列管理
- 任务状态跟踪
- 任务结果收集
- 增量处理支持
- 错误重试机制

#### API调用管理器
- 外部API统一接口
- API密钥管理（BYOK模式）
- 请求限流与重试
- 响应数据标准化
- 成本优化路由

#### 编辑与修复引擎
- 角色一致性修复
- 局部重绘与修复
- 分镜调整工具
- 参数微调接口
- 批量编辑功能

### 渲染进程架构

#### 用户界面模块
- 项目管理界面
- 物料浏览器
- 任务配置界面
- 任务监控面板
- 插件市场界面

#### 状态管理模块
- 全局状态管理
- 组件状态同步
- 配置持久化
- 实时数据更新

## 数据流设计

### 项目文件结构
```
/project-name/
├── materials/
│   ├── texts/
│   ├── images/
│   └── videos/
├── workflows/
│   ├── comfyui/
│   └── n8n/
├── config/
│   ├── project.json
│   └── assets.json
└── logs/
    └── workflow.log
```

### 数据交互流程
1. 用户操作触发事件
2. 渲染进程发送IPC消息
3. 主进程处理业务逻辑
4. 文件系统或API调用
5. 结果返回渲染进程更新UI

## 技术栈选择

### 核心技术
- Electron 25+
- Node.js 18+
- TypeScript 5+
- React 18+

### 开发工具
- Webpack 5
- ESLint + Prettier
- Jest (单元测试)
- Electron Builder (打包)

## 安全设计

### API密钥管理
- 系统密钥链存储
- 加密传输
- 访问权限控制

### 插件安全
- 插件沙箱执行
- API权限控制
- 代码签名验证

### 文件安全
- 沙箱文件访问
- 路径遍历防护
- 文件类型验证

## 性能优化

### 内存管理
- 懒加载机制
- 缓存策略
- 垃圾回收优化

### 文件操作
- 异步I/O操作
- 批量处理
- 进度反馈

### 插件管理
- 按需加载插件
- 插件资源池管理
- 插件执行队列优化

## 扩展性设计

### 插件系统
- 标准化插件接口
- 动态加载机制
- 插件市场集成
- 版本管理

### 工作流扩展
- 可视化工作流编辑
- 模块化工作流组件
- 工作流模板市场
- 社区贡献机制