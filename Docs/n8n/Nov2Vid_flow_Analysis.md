# N8N AI漫剧自动生成系统 - 完整流程分析报告

> 分析日期: 2026-01-06
> 文件来源: docs/n8n/*.json
> 工作流数量: 5个

---

## 📋 目录

1. [系统概述](#系统概述)
2. [工作流架构](#工作流架构)
3. [子工作流详细分析](#子工作流详细分析)
4. [主工作流详细分析](#主工作流详细分析)
5. [完整执行流程](#完整执行流程)
6. [关键技术点](#关键技术点)
7. [性能与限制](#性能与限制)
8. [与MATRIX Studio集成建议](#与matrix-studio集成建议)
9. [总结与关键发现](#总结与关键发现)

---

## 系统概述

### 功能定位

**AI漫剧自动生成系统** - 将小说文本自动转换为带分镜图和视频的 AI 漫剧

### 核心技术栈

- **AI 模型**: DeepSeek Chat (reasoner 模式用于复杂推理)
- **图片生成**:
  - Z-Image Turbo (文本生成图片，异步)
  - Nano Banana Pro Light I2I (图片生成图片，同步)
- **视频生成**: Sora 2 Video Reverse (异步)
- **工作流引擎**: N8N

### 输入输出

- **输入**:
  - 小说文本 (story)
  - 艺术风格 (art_style, 如"新海诚细腻风格")
- **输出**:
  - 角色固定形象图片
  - 场景背景图片
  - 分镜漫画图片
  - 视频片段 (10秒/段)

---

## 工作流架构

### 架构图

```
主工作流 (AI漫剧-主工作流)
├── 子工作流1: AI漫剧-文生图 (基础图片生成)
├── 子工作流2: AI漫剧-生成分镜图片 (分镜图生成)
├── 子工作流3: AI漫剧-生成分镜图片-批量 (批量调用子工作流2)
├── 子工作流4: AI漫剧-生成视频片段 (单个视频生成)
└── 子工作流5: AI漫剧-生成视频片段-批量 (批量调用子工作流4)
```

### 工作流列表

| 工作流名称 | ID | 类型 | 主要功能 |
|-----------|----|----|---------|
| AI漫剧-主工作流 | vTvxZftq0JdYDMGi | 主流程 | 总编排器，协调所有子流程 |
| AI漫剧-文生图 | NY9RPErc3s2auyOw | 子流程 | 文本生成图片（异步） |
| AI漫剧-生成分镜图片 | m6rqnV3ifewk9YED | 子流程 | 图生图（同步） |
| AI漫剧-生成分镜图片-批量 | (隐含) | 子流程 | 批量调用分镜图片生成 |
| AI漫剧-生成视频片段 | SRpomn5eBj40M306 | 子流程 | 图片生成视频（异步） |
| AI漫剧-生成视频片段-批量 | aDQrBeO1mcTDd3Ku | 子流程 | 批量调用视频生成 |

---

## 子工作流详细分析

### 1. AI漫剧-文生图 (ID: NY9RPErc3s2auyOw)

#### 功能
基础的文本到图片生成工作流，使用异步任务模式

#### 触发方式
- `executeWorkflowTrigger` (被其他工作流调用)
- 手动触发 (已禁用)

#### 输入参数
```typescript
{
  prompt: string,    // 图片生成提示词
  width: number,     // 图片宽度
  height: number     // 图片高度
}
```

#### 输出结果
```typescript
{
  image_filepath: string,  // 本地文件路径
  image_url: string        // 远程URL
}
```

#### 流程图

```
┌─────────────────────────────────────────────────────────────┐
│ 1. When Executed by Another Workflow                        │
│    - 接收: prompt, width, height                            │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 2. 配置字段 (Set)                                           │
│    - 提取输入参数                                           │
│    - 设置 output_folder_path = /data/                       │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 3. 发起任务 (HTTP Request)                                  │
│    - POST https://api.jiekou.ai/v3/async/z-image-turbo     │
│    - Body: { size: "width*height", prompt }                 │
│    - 返回: { task_id }                                      │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 4. If (检查 task_id 是否存在)                               │
│    - True: 进入轮询流程                                     │
│    - False: 重新发起任务                                    │
└────────┬───────┬────────────────────────────────────────────┘
         │       │
         │       └─────> (False) 回到步骤 3
         v
    ┌────────────────────────────────────┐
    │ 5. Wait (等待 10 秒)                │
    └────────────┬───────────────────────┘
                 │
                 v
    ┌────────────────────────────────────┐
    │ 6. 查询状态 (HTTP Request)          │
    │    - GET /v3/async/task-result     │
    │    - 参数: task_id                  │
    │    - 返回: { task: { status, ... }}│
    └────────────┬───────────────────────┘
                 │
                 v
    ┌────────────────────────────────────┐
    │ 7. If1 (检查任务状态)               │
    │    - SUCCEED: 下载图片              │
    │    - 其他: 检查是否继续等待         │
    └────┬───────┬───────────────────────┘
         │       │
(True)  │       │ (False)
         │       v
         │   ┌──────────────────────────┐
         │   │ If2 (检查是否还在队列中)  │
         │   │ - QUEUED/PROCESSING: 等待│
         │   └───────┬──────────────────┘
         │           │
         │           └──> 回到步骤 5
         │
         v
    ┌────────────────────────────────────┐
    │ 8. 下载图片 (HTTP Request)          │
    │    - GET images[0].image_url       │
    │    - 返回二进制图片数据             │
    └────────────┬───────────────────────┘
                 │
                 v
    ┌────────────────────────────────────┐
    │ 9. Read/Write Files from Disk      │
    │    - 保存到: /data/img_{时间戳}.jpg│
    │    - 返回: fileName                 │
    └────────────┬───────────────────────┘
                 │
                 v
    ┌────────────────────────────────────┐
    │ 10. 执行结束返回字段 (Set)          │
    │     - 返回: {                       │
    │         image_filepath,             │
    │         image_url                   │
    │       }                             │
    └────────────────────────────────────┘
```

#### 关键特性
- **异步轮询机制**: 提交任务后通过 Wait 节点每 10 秒轮询一次状态
- **重试逻辑**: 如果 task_id 不存在会重新发起任务
- **状态检查**: 支持 QUEUED、PROCESSING、SUCCEED 等状态

---

### 2. AI漫剧-生成分镜图片 (ID: m6rqnV3ifewk9YED)

#### 功能
基于参考图片生成分镜图片 (图生图 I2I)

#### 触发方式
- `executeWorkflowTrigger` (被其他工作流调用)
- 手动触发 (已禁用)

#### 输入参数
```typescript
{
  prompt: string,         // 图片生成提示词
  image_urls: string[],   // 参考图片 URL 数组
  image_size: string      // 图片尺寸 (如 "9x16")
}
```

#### 输出结果
```typescript
{
  image_filepath: string,
  image_url: string
}
```

#### 流程图

```
┌─────────────────────────────────────────────────────────────┐
│ 1. When Executed by Another Workflow                        │
│    - 接收: prompt, image_urls, image_size                   │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 2. 配置字段 (Set)                                           │
│    - 提取并设置输入参数                                     │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 3. Code in JavaScript2                                      │
│    - 构建请求数据对象:                                      │
│      {                                                       │
│        size: image_size,                                     │
│        prompt: prompt,                                       │
│        images: image_urls,                                   │
│        quality: "2k",                                        │
│        response_format: "url"                                │
│      }                                                       │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 4. 发起任务 (HTTP Request)                                  │
│    - POST https://api.jiekou.ai/v3/nano-banana-pro-light-i2i│
│    - 传入上一步构建的数据                                   │
│    - 返回: { data: [{ url }] }                              │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 5. 下载图片 (HTTP Request)                                  │
│    - GET data[0].url                                        │
│    - 返回二进制图片数据                                     │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 6. Read/Write Files from Disk                               │
│    - 保存到: /data/img_{时间戳}_{随机数}.jpeg              │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 7. 执行结束返回字段 (Set)                                   │
│    - 返回: {                                                │
│        image_filepath: fileName,                             │
│        image_url: data[0].url                                │
│      }                                                       │
└─────────────────────────────────────────────────────────────┘
```

#### 关键特性
- **同步调用**: 与"文生图"不同，这个是同步 API，直接返回结果
- **图生图 (I2I)**: 使用 nano-banana-pro-light-i2i 模型，支持参考图片
- **更快速**: 无需轮询等待

---

### 3. AI漫剧-生成视频片段 (ID: SRpomn5eBj40M306)

#### 功能
基于图片生成视频片段，使用异步任务模式并带超时控制

#### 触发方式
- `executeWorkflowTrigger` (被其他工作流调用)
- 手动触发 (已禁用)

#### 输入参数
```typescript
{
  prompt: string,        // 视频生成提示词
  image_url: string,     // 参考图片 URL
  video_ratio: string    // 视频比例 (如 "1280x720")
}
```

#### 输出结果
```typescript
{
  video_filepath: string,
  video_url: string
}
```

#### 流程图

```
┌─────────────────────────────────────────────────────────────┐
│ 1. When Executed by Another Workflow                        │
│    - 接收: prompt, image_url, video_ratio                   │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 2. 配置字段 (Set)                                           │
│    - 提取输入参数                                           │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 3. Code in JavaScript                                        │
│    - 记录开始时间: start_time = Date.now()                  │
│    - 构建请求数据:                                          │
│      {                                                       │
│        prompt, image, size, duration: 10                     │
│      }                                                       │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 4. 发起任务 (HTTP Request)                                  │
│    - POST /v3/async/sora-2-video-reverse                    │
│    - 返回: { task_id }                                      │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 5. If (检查 task_id 是否存在)                               │
│    - True: 等待                                             │
│    - False: 重新发起任务                                    │
└────────┬───────┬────────────────────────────────────────────┘
         │       │
         │       └─────> (False) 回到步骤 4
         v
    ┌────────────────────────────────────┐
    │ 6. Wait (等待 10 秒)                │
    └────────────┬───────────────────────┘
                 │
                 v
    ┌────────────────────────────────────┐
    │ 7. 查询状态 (HTTP Request)          │
    │    - GET /v3/async/task-result     │
    │    - 参数: task_id                  │
    └────────────┬───────────────────────┘
                 │
                 v
    ┌────────────────────────────────────┐
    │ 8. If1 (检查任务状态)               │
    │    - SUCCEED: 下载视频              │
    │    - 其他: 进入 If2                 │
    └────┬───────┬───────────────────────┘
         │       │
(True)  │       │ (False)
         │       v
         │   ┌──────────────────────────┐
         │   │ If2 (检查是否还在队列中)  │
         │   │ - QUEUED/PROCESSING      │
         │   └───────┬──────────────────┘
         │           │
         │           v
         │   ┌──────────────────────────┐
         │   │ If3 (检查是否超时)        │
         │   │ - 当前时间 - start_time  │
         │   │   < 10分钟: 继续等待     │
         │   │ - 否则: 重新发起任务     │
         │   └───┬───────┬──────────────┘
         │       │       │
         │  (True)│       └──> (False) 回到步骤 3
         │       │
         │       └──────> 回到步骤 6
         │
         v
    ┌────────────────────────────────────┐
    │ 9. 下载视频 (HTTP Request)          │
    │    - GET videos[0].video_url       │
    └────────────┬───────────────────────┘
                 │
                 v
    ┌────────────────────────────────────┐
    │ 10. Read/Write Files from Disk     │
    │     - 保存到: /data/video_*.mp4    │
    └────────────┬───────────────────────┘
                 │
                 v
    ┌────────────────────────────────────┐
    │ 11. 执行结束返回字段 (Set)          │
    │     - 返回: {                       │
    │         video_filepath,             │
    │         video_url                   │
    │       }                             │
    └────────────────────────────────────┘
```

#### 关键特性
- **超时控制**: 最长等待 10 分钟，超时后重新发起任务
- **异步轮询**: 每 10 秒检查一次任务状态
- **使用 Sora 2**: 调用 sora-2-video-reverse API 生成视频

---

### 4. AI漫剧-生成视频片段-批量 (ID: aDQrBeO1mcTDd3Ku)

#### 功能
批量调用"生成视频片段"子工作流

#### 触发方式
`executeWorkflowTrigger` (被主工作流调用)

#### 输入参数
```typescript
{
  video_storyboards: Array<{
    index: number,
    video_prompt: string,
    image_url: string
  }>,
  child_workflow_id: string  // 要调用的子工作流 ID
}
```

#### 输出结果
```typescript
{
  data: Array<{
    video_filepath: string,
    video_url: string
  }>
}
```

#### 流程图

```
┌─────────────────────────────────────────────────────────────┐
│ 1. Start (executeWorkflowTrigger)                           │
│    - 接收: video_storyboards[], child_workflow_id          │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 2. Split Out4                                                │
│    - 拆分 video_storyboards 数组                            │
│    - 每个元素单独处理                                       │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 3. Loop Over Items5 (循环处理)                              │
│    - 逐个处理每个视频分镜                                   │
│    - batch_size = 1                                          │
└────────┬───────┬────────────────────────────────────────────┘
         │       │
    (完成)│       │ (处理中)
         │       v
         │   ┌──────────────────────────────────────────────┐
         │   │ 4. Call 'AI漫剧-生成视频片段' (executeWorkflow)│
         │   │    - 调用子工作流                            │
         │   │    - 传入参数:                               │
         │   │      • prompt = video_prompt                 │
         │   │      • image_url                             │
         │   │      • video_ratio = "1280x720"              │
         │   │    - 返回: { video_filepath, video_url }     │
         │   └───────────┬──────────────────────────────────┘
         │               │
         │               └──> 回到步骤 3 (继续循环)
         v
    ┌────────────────────────────────────┐
    │ 5. Aggregate4                      │
    │    - 聚合所有结果                  │
    └────────────┬───────────────────────┘
                 │
                 v
    ┌────────────────────────────────────┐
    │ 6. Return (Set)                    │
    │    - 返回: { data: [...] }         │
    └────────────────────────────────────┘
```

#### 关键特性
- **批量处理模式**: 使用 Loop Over Items 逐个调用子工作流
- **动态子工作流**: 通过 child_workflow_id 参数指定要调用的工作流
- **顺序执行**: 每次只处理一个项目 (batch_size = 1)

---

### 5. AI漫剧-生成分镜图片-批量

与"生成视频片段-批量"类似，这个工作流用于批量调用"生成分镜图片"子工作流。

---

## 主工作流详细分析

### AI漫剧-主工作流 (ID: vTvxZftq0JdYDMGi)

这是整个系统的**核心编排工作流**，包含 4 个主要阶段，共 30+ 个节点。

#### 阶段划分 (根据 Sticky Note)

```
Stage 0: 初始化和配置
Stage 1: 分析内容，提取场景
Stage 2: 角色、场景图片生成
Stage 3: 生成图片和视频的分镜提示词
Stage 4: 使用 banana pro 生成图片，使用 sora2 生成视频
```

---

### Stage 0: 初始化和配置

```
┌─────────────────────────────────────────────────────────────┐
│ 1. When clicking 'Execute workflow' (手动触发)              │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 2. 基础字段 (Set)                                           │
│    - 设置配置参数:                                          │
│      • output_folder_path = "/data/"                        │
│      • 文生图工作流id                                       │
│      • 生成分镜图片-批量-工作流id                           │
│      • 生成视频片段-批量-工作流id                           │
│      • 生成分镜图片-工作流id                                │
│      • 生成视频片段-工作流id                                │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 3. 视频配置 (Set)                                           │
│    - 设置用户输入:                                          │
│      • story: 小说文本                                      │
│      • art_style: "新海诚细腻风格"                          │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
```

---

### Stage 1: 分析内容，提取场景

```
┌─────────────────────────────────────────────────────────────┐
│ 4. AI Agent1 (DeepSeek Reasoner)                            │
│    - AI 模型: DeepSeek Chat Model1                          │
│    - 输出解析器: Structured Output Parser1                  │
│    - 任务: 场景分解与物料识别                               │
│      输入: story (小说文本)                                 │
│      输出: {                                                 │
│        scenes: [                                             │
│          {                                                   │
│            scene: "场景名称（地点，时间段）",              │
│            story: "该场景的完整剧情",                       │
│            characters: ["角色1", "角色2"]                   │
│          }                                                   │
│        ]                                                     │
│      }                                                       │
│    - Prompt 要点:                                           │
│      • 按"地点+时间段"划分场景                              │
│      • 识别需要固定形象的角色                               │
│      • 识别所有出现的场景                                   │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 5. Code in JavaScript                                        │
│    - 提取并去重:                                            │
│      • scenes = [...new Set(data.map(item => item.scene))]  │
│      • characters = [...new Set(data.flatMap(...))]         │
│    - 返回: { scenes: [], characters: [] }                   │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 6. Edit Fields1 (Set)                                        │
│    - 格式化输出:                                            │
│      • scenes: 场景名称数组                                 │
│      • characters: 角色名称数组                             │
└────────────────┬────────────────────────────────────────────┘
                 │
                 ├─────────────────┐
                 │                 │
                 v                 v
```

---

### Stage 2: 角色、场景图片生成 (并行)

```
    分支 A: 角色图片生成              分支 B: 场景图片生成
         │                                │
         v                                v
┌─────────────────────────┐    ┌─────────────────────────┐
│ 7A. 人物 (AI Agent)      │    │ 7B. 场景 (AI Agent)      │
│  - 模型: DeepSeek Chat   │    │  - 模型: DeepSeek Chat   │
│  - 输出: Structured      │    │  - 输出: Structured      │
│    Output Parser2        │    │    Output Parser3        │
│  - 输入:                 │    │  - 输入:                 │
│    • characters 列表     │    │    • scenes 列表         │
│    • 小说原文            │    │    • 小说原文            │
│    • art_style           │    │  - 输出:                 │
│  - 输出:                 │    │    [{                    │
│    [{                    │    │      name: "场景名",     │
│      name: "角色名",     │    │      prompt: "SD格式",   │
│      prompt: "SD格式",   │    │      description: "描述" │
│      description: "描述",│    │    }]                    │
│      appearance: "外观"  │    │                          │
│    }]                    │    │                          │
│  - Prompt 要点:          │    │  - Prompt 要点:          │
│    • 生成固定角色形象    │    │    • 生成场景背景图      │
│    • 半身照，白底背景    │    │    • 不含人物和道具      │
│    • SD提示词格式        │    │    • 推断空间大小        │
└────────┬────────────────┘    └────────┬────────────────┘
         │                                │
         v                                v
┌─────────────────────────┐    ┌─────────────────────────┐
│ 8A. Split Out            │    │ 8B. Split Out1           │
│  - 拆分 output 数组      │    │  - 拆分 output 数组      │
└────────┬────────────────┘    └────────┬────────────────┘
         │                                │
         v                                v
┌─────────────────────────┐    ┌─────────────────────────┐
│ 9A. Loop Over Items      │    │ 9B. Loop Over Items1     │
│  - 逐个处理角色          │    │  - 逐个处理场景          │
└────┬───┬────────────────┘    └────┬───┬────────────────┘
     │   │                           │   │
     │   v                           │   v
     │ ┌───────────────────┐         │ ┌───────────────────┐
     │ │ 10A. Call '文生图'│         │ │ 10B. Call '文生图1'│
     │ │  - 生成角色图片   │         │ │  - 生成场景图片   │
     │ │  - 输入:          │         │ │  - 输入:          │
     │ │    prompt         │         │ │    prompt         │
     │ │    width=810      │         │ │    width=810      │
     │ │    height=1440    │         │ │    height=1440    │
     │ │  - 返回:          │         │ │  - 返回:          │
     │ │    image_filepath │         │ │    image_filepath │
     │ │    image_url      │         │ │    image_url      │
     │ └────────┬──────────┘         │ └────────┬──────────┘
     │          │                     │          │
     │          v                     │          v
     │ ┌───────────────────┐         │ ┌───────────────────┐
     │ │ 11A. Edit Fields8 │         │ │ 11B. Edit Fields7 │
     │ │  - 合并数据:      │         │ │  - 合并数据:      │
     │ │    name, prompt,  │         │ │    name, prompt,  │
     │ │    description,   │         │ │    description,   │
     │ │    appearance,    │         │ │    image_filepath,│
     │ │    image_filepath,│         │ │    image_url      │
     │ │    image_url      │         │ │                   │
     │ └────────┬──────────┘         │ └────────┬──────────┘
     │          │                     │          │
     │          └──> 回到 9A          │          └──> 回到 9B
     │                                │
     v (所有完成)                     v (所有完成)
┌─────────────────────────┐    ┌─────────────────────────┐
│ 12A. Aggregate           │    │ 12B. Aggregate1          │
│  - 聚合所有角色结果      │    │  - 聚合所有场景结果      │
└────────┬────────────────┘    └────────┬────────────────┘
         │                                │
         v                                v
┌─────────────────────────┐    ┌─────────────────────────┐
│ 13A. Code in JavaScript1 │    │ 13B. Code in JavaScript2 │
│  - 为每个角色添加 id     │    │  - 为每个场景添加 id     │
│    (时间戳+随机数)       │    │    (时间戳+随机数)       │
└────────┬────────────────┘    └────────┬────────────────┘
         │                                │
         v                                v
┌─────────────────────────┐    ┌─────────────────────────┐
│ 14A. 角色-整理 (Set)     │    │ 14B. 场景-整理 (Set)     │
│  - character_list        │    │  - scene_list            │
└────────┬────────────────┘    └────────┬────────────────┘
         │                                │
         └────────────┬───────────────────┘
                      │
                      v
         ┌─────────────────────────┐
         │ 15. Merge (合并3个输入)  │
         │  - 输入1: 角色-整理      │
         │  - 输入2: 场景-整理      │
         │  - 输入3: (待定)         │
         └────────┬────────────────┘
                  │
                  v
         ┌─────────────────────────┐
         │ 16. Aggregate3           │
         │  - 聚合所有数据          │
         └────────┬────────────────┘
                  │
                  v
         ┌─────────────────────────┐
         │ 17. 角色-场景整理 (Set)  │
         │  - character_list        │
         │  - scene_list            │
         └────────┬────────────────┘
                  │
                  v
```

---

### Stage 3: 生成分镜脚本 (生成图片和视频的分镜提示词)

这个阶段非常复杂，包含多个并行和串行的步骤。

#### Part 1: 生成故事摘要

```
┌─────────────────────────────────────────────────────────────┐
│ 18. Split Out2 (拆分场景列表)                                │
│     - 从 scene_list 中拆分每个场景                          │
└────────────────┬────────────────────────────────────────────┘
                 │
                 v
┌─────────────────────────────────────────────────────────────┐
│ 19. Loop Over Items2 (循环处理每个场景)                     │
│     - 为每个场景生成摘要                                    │
└────────┬───────┬────────────────────────────────────────────┘
         │       │
    (完成)│       │ (处理中)
         │       v
         │   ┌──────────────────────────────────────────────┐
         │   │ 20. 获取场景序号和场景对应故事 (Code)         │
         │   │     - 根据场景 id 找到对应的序号和 story      │
         │   └───────────┬──────────────────────────────────┘
         │               │
         │               v
         │   ┌──────────────────────────────────────────────┐
         │   │ 21. 生成场景故事摘要 (AI Agent)               │
         │   │     - 模型: DeepSeek Chat Model              │
         │   │     - 输出: Structured Output Parser         │
         │   │     - 任务: 将场景故事压缩为 100 字摘要      │
         │   │     - 返回: { summary }                       │
         │   └───────────┬──────────────────────────────────┘
         │               │
         │               v
         │   ┌──────────────────────────────────────────────┐
         │   │ 22. Edit Fields2 (Set)                        │
         │   │     - 提取 summary 字段                       │
         │   └───────────┬──────────────────────────────────┘
         │               │
         │               └──> 回到步骤 19 (继续循环)
         v
    ┌────────────────────────────────────┐
    │ 23. Aggregate2                     │
    │     - 聚合所有场景摘要             │
    │     - 返回: { summary: [...] }     │
    └────────────┬───────────────────────┘
                 │
                 v
    ┌────────────────────────────────────┐
    │ 24. 生成整段故事摘要 (AI Agent)    │
    │     - 模型: DeepSeek Chat Model4   │
    │     - 输出: Structured Output      │
    │       Parser4                      │
    │     - 任务: 生成整个故事的摘要     │
    │     - 返回: { summary }            │
    └────────────┬───────────────────────┘
                 │
                 v
    ┌────────────────────────────────────┐
    │ 25. 故事摘要整理 (Set)             │
    │     - chapter_summary: 整段摘要    │
    │     - scene_summary: 各场景摘要数组│
    └────────────┬───────────────────────┘
                 │
                 v
    ┌────────────────────────────────────┐
    │ 26. Edit Fields3 (Set)             │
    │     - 为 scene_list 添加 index     │
    └────────────┬───────────────────────┘
                 │
                 v
    ┌────────────────────────────────────┐
    │ 27. Split Out3                     │
    │     - 拆分带 index 的 scene_list   │
    └────────────┬───────────────────────┘
                 │
                 v
```

#### Part 2: 生成视频分镜脚本和图片分镜脚本

```
┌─────────────────────────────────────────────────────────────┐
│ 28. Loop Over Items3 (循环处理每个场景)                     │
│     - 为每个场景生成分镜脚本                                │
└────────┬───────┬────────────────────────────────────────────┘
         │       │
    (完成)│       │ (处理中)
         │       v
         │   ┌──────────────────────────────────────────────┐
         │   │ 29. 分镜数据整理 (Code)                       │
         │   │     - 整合场景、角色、故事摘要等信息          │
         │   │     - 返回:                                   │
         │   │       {                                       │
         │   │         scene: { id, name },                  │
         │   │         story: "场景剧情",                    │
         │   │         characters: [...],                    │
         │   │         globalSummary: "整段摘要",            │
         │   │         previousSummary: "前情提要",          │
         │   │         nextSummary: "后续预告"               │
         │   │       }                                       │
         │   └───────────┬──────────────────────────────────┘
         │               │
         │               v
         │   ┌──────────────────────────────────────────────┐
         │   │ 30. 生成剧本分镜描述的提示词 (AI Agent)       │
         │   │     - 模型: DeepSeek Chat Model5             │
         │   │     - 输出: Structured Output Parser7        │
         │   │     - 任务: 将文本转化为10秒视频片段          │
         │   │     - 输出格式:                               │
         │   │       [{                                      │
         │   │         duration: "10s",                      │
         │   │         text_covered: "原文片段",             │
         │   │         visual_summary: "视觉概要",           │
         │   │         shots: ["镜头1", "镜头2", ...]        │
         │   │       }]                                      │
         │   └───────────┬──────────────────────────────────┘
         │               │
         │               v
         │   ┌──────────────────────────────────────────────┐
         │   │ 31. Code in JavaScript3                       │
         │   │     - 整理分镜数据                            │
         │   │     - 提取角色信息                            │
         │   │     - 返回: { scriptScenesText, characters }  │
         │   └───────────┬──────────────────────────────────┘
         │               │
         │               ├─────────────────────────────┐
         │               │                             │
         │               v                             v
         │   ┌────────────────────────┐    ┌────────────────────────┐
         │   │ 32A. sora2格式的视频   │    │ 32B. 生成图片分镜       │
         │   │      分镜脚本          │    │                        │
         │   │  - AI Agent            │    │  - AI Agent            │
         │   │  - 模型: DeepSeek      │    │  - 模型: DeepSeek      │
         │   │    Chat Model6         │    │    Chat Model9         │
         │   │  - 输出: Structured    │    │  - 输出: Structured    │
         │   │    Output Parser8      │    │    Output Parser9      │
         │   │  - 任务: 生成Sora2     │    │  - 任务: 将视频脚本    │
         │   │    格式的视频参数      │    │    转化为静态漫画分镜  │
         │   │  - 输出:               │    │  - 输出:               │
         │   │    [{                  │    │    [{                  │
         │   │      scene,            │    │      scene_index,      │
         │   │      style,            │    │      character_ids,    │
         │   │      mood,             │    │      panels: [{        │
         │   │      sfx,              │    │        panel_id,       │
         │   │      cinematography    │    │        image_prompt    │
         │   │    }]                  │    │      }]                │
         │   └────────┬───────────────┘    │    }]                  │
         │            │                     └────────┬───────────────┘
         │            v                              │
         │   ┌────────────────────────┐              │
         │   │ 33A. Code in JavaScript8│             │
         │   │  - 整理视频分镜数据    │              │
         │   └────────┬───────────────┘              │
         │            │                              │
         │            v                              v
         │   ┌────────────────────────┐    ┌────────────────────────┐
         │   │ 34A. 数据整理           │    │ 34B. Code in JavaScript7│
         │   │  - 构建 video_         │    │  - 构建图片分镜 prompt  │
         │   │    storyboards         │    │  - 返回: { data }       │
         │   │  - 包含:               │    │                        │
         │   │    video_prompt,       │    │                        │
         │   │    image_url           │    │                        │
         │   └────────┬───────────────┘    └────────┬───────────────┘
         │            │                              │
         │            │                              v
         │            │                     ┌────────────────────────┐
         │            │                     │ 35. 最终图片分镜脚本    │
         │            │                     │     整理 (Set)          │
         │            │                     │  - image_storyboards    │
         │            │                     └────────┬───────────────┘
         │            │                              │
         │            │                              v
         │            │                     ┌────────────────────────┐
         │            │                     │ 36. Call AI漫剧-生成   │
         │            │                     │     分镜图片-批量       │
         │            │                     │  - 批量生成分镜图片    │
         │            │                     │  - 返回: { data }       │
         │            │                     └────────┬───────────────┘
         │            │                              │
         │            └──────────┬───────────────────┘
         │                       v
         │              ┌────────────────────────┐
         │              │ 37. Call AI漫剧-生成   │
         │              │     视频片段-批量       │
         │              │  - 批量生成视频片段    │
         │              │  - 返回: { data }       │
         │              └────────┬───────────────┘
         │                       │
         │                       v
         │              ┌────────────────────────┐
         │              │ 38. 生成视频后字段整理  │
         │              │  - video_data          │
         │              └────────┬───────────────┘
         │                       │
         │                       └──> 回到步骤 28 (继续循环)
         v
    ┌────────────────────────────────────┐
    │ 39. Aggregate5                     │
    │     - 聚合所有场景的最终结果       │
    └────────────────────────────────────┘
```

---

## 完整执行流程

### 总体流程图

```
════════════════════════════════════════════════════════════════
                        【主工作流总览】
════════════════════════════════════════════════════════════════

输入: 小说文本 (story) + 艺术风格 (art_style)
输出: 多场景的分镜图片 + 视频片段

┌────────────────────────────────────────────────────────────┐
│                    Stage 0: 初始化配置                      │
└────────────────────────────────────────────────────────────┘
                             │
                             v
┌────────────────────────────────────────────────────────────┐
│                Stage 1: 场景分解与物料识别                  │
│                                                             │
│  输入: story (小说文本)                                     │
│  处理: DeepSeek Reasoner AI 分析                            │
│  输出:                                                      │
│    • scenes: ["场景1", "场景2", ...]                       │
│    • characters: ["角色1", "角色2", ...]                   │
│    • 每个场景的详细信息 (scene, story, characters)         │
└────────────────────────────────────────────────────────────┘
                             │
                             v
┌────────────────────────────────────────────────────────────┐
│            Stage 2: 角色与场景图片生成 (并行)               │
│                                                             │
│  ┌───────────────────────┐    ┌───────────────────────┐   │
│  │   分支 A: 角色图片     │    │   分支 B: 场景图片     │   │
│  │                        │    │                        │   │
│  │ 1. AI 生成角色 Prompt  │    │ 1. AI 生成场景 Prompt  │   │
│  │    (SD 格式)           │    │    (SD 格式)           │   │
│  │    ↓                   │    │    ↓                   │   │
│  │ 2. 循环调用文生图 API  │    │ 2. 循环调用文生图 API  │   │
│  │    • Z-Image Turbo     │    │    • Z-Image Turbo     │   │
│  │    • 异步轮询等待      │    │    • 异步轮询等待      │   │
│  │    ↓                   │    │    ↓                   │   │
│  │ 3. 聚合结果，添加 ID   │    │ 3. 聚合结果，添加 ID   │   │
│  │    ↓                   │    │    ↓                   │   │
│  │ 输出: character_list   │    │ 输出: scene_list       │   │
│  │  [{                    │    │  [{                    │   │
│  │    id, name, prompt,   │    │    id, name, prompt,   │   │
│  │    description,        │    │    description,        │   │
│  │    appearance,         │    │    image_filepath,     │   │
│  │    image_filepath,     │    │    image_url           │   │
│  │    image_url           │    │  }]                    │   │
│  │  }]                    │    │                        │   │
│  └───────────┬───────────┘    └───────────┬───────────┘   │
│              └────────────┬────────────────┘               │
│                           v                                │
│                      合并为一个对象:                        │
│                  { character_list, scene_list }            │
└────────────────────────────────────────────────────────────┘
                             │
                             v
┌────────────────────────────────────────────────────────────┐
│         Stage 3: 生成分镜脚本 (图片 + 视频)                │
│                                                             │
│  Step 3.1: 生成故事摘要                                    │
│  ├─ 为每个场景生成 100 字摘要                              │
│  ├─ 生成整段故事摘要                                       │
│  └─ 输出: { chapter_summary, scene_summary[] }             │
│                                                             │
│  Step 3.2: 循环处理每个场景                                │
│  ┌──────────────────────────────────────────────────┐     │
│  │  对于 scene_list 中的每个场景:                    │     │
│  │                                                    │     │
│  │  1. 整合上下文数据 (分镜数据整理)                 │     │
│  │     - globalSummary: 整段摘要                      │     │
│  │     - previousSummary: 前一场景摘要                │     │
│  │     - story: 当前场景剧情                          │     │
│  │     - nextSummary: 下一场景预告                    │     │
│  │     - characters: 在场角色列表                     │     │
│  │                                                    │     │
│  │  2. 生成视频分镜描述 (Step A)                      │     │
│  │     - 使用 DeepSeek 将文本转化为 10 秒视频片段     │     │
│  │     - 输出: [{                                     │     │
│  │         duration: "10s",                           │     │
│  │         visual_summary,                            │     │
│  │         shots: ["镜头1", "镜头2", ...]             │     │
│  │       }]                                           │     │
│  │                                                    │     │
│  │  3. 转化为 Sora2 格式 (Step B)                     │     │
│  │     - 使用 DeepSeek 生成技术化参数                 │     │
│  │     - 输出: [{                                     │     │
│  │         scene, style, mood, sfx,                   │     │
│  │         cinematography                             │     │
│  │       }]                                           │     │
│  │          │                                         │     │
│  │          ├──────────────────┬─────────────────┐   │     │
│  │          v                  v                 v   │     │
│  │  4A. 生成图片分镜    4B. 生成视频分镜          │   │     │
│  │     - 将视频脚本转     - 整合角色、场景图     │   │     │
│  │       为静态漫画分       为视频 prompt        │   │     │
│  │       镜 prompt                               │   │     │
│  │     - 输出:            - 输出:                │   │     │
│  │       panels[]           video_storyboards[] │   │     │
│  │          │                  │                 │   │     │
│  │          v                  v                 │   │     │
│  │  5A. 批量生成分镜   5B. 批量生成视频片段      │   │     │
│  │      图片                                     │   │     │
│  │     - 调用 Banana      - 调用 Sora 2          │   │     │
│  │       Pro I2I            Video API            │   │     │
│  │     - 使用参考图       - 基于分镜图生成       │   │     │
│  │       (角色+场景)        10秒视频             │   │     │
│  │                                                │   │     │
│  └────────────────────────────────────────────────┘     │
│                                                             │
└────────────────────────────────────────────────────────────┘
                             │
                             v
┌────────────────────────────────────────────────────────────┐
│                 Stage 4: 输出最终结果                       │
│                                                             │
│  聚合所有场景的:                                           │
│    • 分镜图片 (多格漫画)                                   │
│    • 视频片段 (10秒视频)                                   │
│    • 相关元数据                                            │
└────────────────────────────────────────────────────────────┘
```

---

## 关键技术点

### 1. 异步任务轮询机制

用于 Z-Image Turbo 和 Sora 2 API:

```
发起任务 → 获得 task_id
    ↓
等待 10 秒 (Wait 节点)
    ↓
查询任务状态
    ↓
    ├─ SUCCEED → 下载结果
    ├─ QUEUED/PROCESSING → 继续等待 (回到 Wait)
    └─ 超时 (10分钟) → 重新发起任务
```

**关键参数**:
- 轮询间隔: 10 秒
- 超时时间: 10 分钟 (600秒)
- 重试策略: 超时后重新发起任务

---

### 2. AI Prompt 工程

系统使用了 **6 个不同的 AI Agent**，每个都有专门的 Prompt:

| Agent | 模型 | 任务 | 输出格式 |
|-------|------|------|---------|
| 1. 场景分解 Agent | DeepSeek Reasoner | 将小说按"地点+时间"拆分场景，识别角色 | JSON: scenes[] |
| 2. 角色 Prompt 生成 | DeepSeek Chat | 生成固定角色形象的 SD 提示词 | JSON: characters[] with prompts |
| 3. 场景 Prompt 生成 | DeepSeek Chat | 生成场景背景的 SD 提示词 | JSON: scenes[] with prompts |
| 4. 分镜描述 Agent | DeepSeek Chat | 将文本转化为 10 秒视频片段描述 | JSON: segments[] with shots |
| 5. Sora2 格式化 Agent | DeepSeek Chat | 将分镜描述转化为技术化参数 | JSON: sora2 format |
| 6. 图片分镜 Agent | DeepSeek Chat | 将视频脚本转化为静态漫画分镜 | JSON: panels[] |

**Prompt 设计要点**:
- 使用 Structured Output Parser 确保 JSON 格式正确
- 提供详细的任务说明和示例
- 明确输出字段要求
- 使用上下文信息 (前情提要、整段摘要等)

---

### 3. 数据流与依赖关系

```
小说文本
  └─> AI 分析 → scenes[] + characters[]
        ├─> 角色图片生成 (并行)
        ├─> 场景图片生成 (并行)
        └─> 等待两者完成 → 合并
              └─> 为每个场景:
                    ├─> 生成故事摘要
                    ├─> 生成视频分镜脚本
                    │     └─> 生成图片分镜 + 视频分镜
                    │           ├─> 调用图生图 API (使用角色/场景参考图)
                    │           └─> 调用视频生成 API (使用分镜图)
                    └─> 返回结果
```

**关键依赖**:
- 图片分镜和视频生成都依赖于角色/场景图片
- 分镜脚本依赖于故事摘要
- 每个场景的处理是顺序执行的 (Loop Over Items3)

---

### 4. 批量处理模式

使用 N8N 的 `splitInBatches` + `executeWorkflow` 模式:

```javascript
// 伪代码
for each item in array:
    result = await callChildWorkflow(item)
    aggregate(result)
return all_results
```

**特点**:
- 顺序执行 (batch_size = 1)
- 支持大规模场景处理
- 可以动态指定子工作流 ID

---

### 5. 错误处理与重试

**节点级重试**:
```json
{
  "retryOnFail": true,
  "maxTries": 3,
  "waitBetweenTries": 3000
}
```

**超时控制**:
- 视频生成: 10 分钟超时
- 单个场景处理: 无限制 (但每个子任务有超时)

**状态检查**:
- 异步任务: 轮询状态 (QUEUED/PROCESSING/SUCCEED/FAILED)
- 同步任务: 直接返回结果

---

## 性能与限制

### 估算处理时间 (单场景)

| 步骤 | 预估时间 | 说明 |
|------|---------|------|
| 场景分解 | ~30 秒 | AI 推理时间 |
| 角色图片生成 | 2-5 分钟/张 | 异步 API，取决于队列 |
| 场景图片生成 | 2-5 分钟/张 | 异步 API，取决于队列 |
| 分镜脚本生成 | 1-2 分钟 | AI 推理时间 |
| 分镜图片生成 | ~30 秒/张 | 同步 API，较快 |
| 视频生成 | 5-10 分钟/段 | 异步 API，最耗时 |

**总计**:
- **单场景**: 10-20 分钟
- **3 场景 + 5 角色**: 30-60 分钟

### 性能瓶颈

1. **异步 API 等待时间**: 文生图和视频生成依赖外部 API
2. **顺序处理**: Loop Over Items 不支持并行
3. **AI 推理时间**: DeepSeek 模型调用次数多

### 限制

| 限制类型 | 说明 |
|---------|------|
| API 调用频率 | 受 jiekou.ai API 限制 |
| 工作流执行时间 | N8N 默认 2 小时超时 |
| 磁盘空间 | 大量图片和视频文件 |
| 内存使用 | Aggregate 节点会累积所有数据 |

---

## 与MATRIX Studio集成建议

### 1. 物料管理集成

将生成的资产导入 **AssetManager**:

```typescript
// 角色图片
assetManager.addAsset({
  name: character.name,
  type: 'image',
  scope: 'global',  // 角色固定形象，全局共享
  aiMetadata: {
    prompt: character.prompt,
    model: 'z-image-turbo',
    seed: null,  // API 未返回
    steps: null,
    sampler: null
  },
  tags: ['character', 'ai-generated', art_style]
});

// 场景图片
assetManager.addAsset({
  name: scene.name,
  type: 'image',
  scope: 'global',
  aiMetadata: {
    prompt: scene.prompt,
    model: 'z-image-turbo'
  },
  tags: ['scene', 'background', 'ai-generated']
});

// 分镜图片
assetManager.addAsset({
  name: `Scene_${index}_Panel_${panelId}`,
  type: 'image',
  scope: 'project',  // 项目特定
  aiMetadata: {
    prompt: panel.image_prompt,
    model: 'nano-banana-pro-light-i2i',
    referenceImages: [character_url, scene_url]
  },
  tags: ['storyboard', 'panel']
});

// 视频片段
assetManager.addAsset({
  name: `Scene_${index}_Video`,
  type: 'video',
  scope: 'project',
  aiMetadata: {
    prompt: video_prompt,
    model: 'sora-2-video-reverse',
    duration: 10
  },
  tags: ['video', 'scene']
});
```

---

### 2. 工作流系统集成

将 N8N 工作流转化为 **MATRIX Workflow Schema**:

```typescript
// 注册主工作流
workflowRegistry.registerWorkflow({
  id: 'novel-to-video',
  name: 'AI漫剧生成',
  description: '将小说文本转换为分镜图片和视频',
  version: '1.0.0',
  input_schema: z.object({
    story: z.string(),
    art_style: z.string()
  }),
  output_schema: z.object({
    character_list: z.array(CharacterSchema),
    scene_list: z.array(SceneSchema),
    image_storyboards: z.array(ImagePanelSchema),
    video_storyboards: z.array(VideoSegmentSchema)
  }),
  nodes: [
    // 定义节点...
  ],
  edges: [
    // 定义连接...
  ]
});

// 执行工作流
const execution = await workflowStateManager.createExecution({
  workflowId: 'novel-to-video',
  input: {
    story: novelText,
    art_style: '新海诚细腻风格'
  }
});
```

---

### 3. 时间服务集成

使用 **TimeService** 记录所有资产的创建时间:

```typescript
import { TimeService } from '@/main/services/TimeService';

// 创建资产时
const currentTime = await TimeService.getCurrentTime();

assetManager.addAsset({
  // ... 其他字段
  createdAt: currentTime,
  metadata: {
    generatedAt: currentTime,
    workflowExecutionId: executionId
  }
});
```

---

### 4. 任务调度集成

将异步任务提交到 **TaskScheduler**:

```typescript
// 提交文生图任务
const task = await taskScheduler.scheduleTask({
  type: 'api-call',
  name: 'Generate Character Image',
  payload: {
    api: 'z-image-turbo',
    prompt: character.prompt,
    width: 810,
    height: 1440
  },
  priority: 'normal',
  onProgress: (progress) => {
    // 更新进度
  }
});

// 监听任务完成
task.on('completed', (result) => {
  // 保存图片到 AssetManager
});
```

---

### 5. API Manager 集成

配置 **APIManager** 管理外部 API:

```typescript
apiManager.registerAPI({
  id: 'jiekou-ai',
  name: 'Jiekou AI API',
  baseURL: 'https://api.jiekou.ai',
  endpoints: {
    'z-image-turbo': {
      path: '/v3/async/z-image-turbo',
      method: 'POST',
      async: true
    },
    'task-result': {
      path: '/v3/async/task-result',
      method: 'GET',
      async: false
    },
    'nano-banana-i2i': {
      path: '/v3/nano-banana-pro-light-i2i',
      method: 'POST',
      async: false
    },
    'sora2-video': {
      path: '/v3/async/sora-2-video-reverse',
      method: 'POST',
      async: true
    }
  },
  authentication: {
    type: 'bearer',
    token: process.env.JIEKOU_API_KEY
  }
});
```

---

### 6. 工作流编辑器设计建议

参考 N8N 的节点连接方式，MATRIX 工作流编辑器可以:

1. **使用 @xyflow/react** (已在项目中使用)
2. **节点类型**:
   - AI Agent 节点
   - HTTP Request 节点
   - Code 节点
   - Loop 节点
   - Condition 节点
   - Set 节点
3. **连接线规则**:
   - main: 主数据流
   - ai_languageModel: AI 模型连接
   - ai_outputParser: 输出解析器连接

---

## 总结与关键发现

### 🎯 系统架构优势

1. **模块化设计**: 主-子工作流架构清晰，易于维护
2. **可复用性**: 子工作流可被多个主流程调用
3. **灵活性**: 通过 child_workflow_id 动态指定子工作流
4. **容错性**: 异步轮询机制和重试逻辑确保稳定性

### ⚡ 核心创新点

1. **智能上下文管理**:
   - 前情提要、整段摘要、后续预告
   - 确保 AI 生成的连贯性

2. **分层 Prompt 工程**:
   - 6 个专门的 AI Agent
   - 每个负责不同的转化任务

3. **异步任务处理**:
   - 轮询机制优雅处理长时间任务
   - 超时重试确保稳定性

4. **多模态生成**:
   - 文本 → 场景分解
   - 文本 → 图片提示词
   - 图片 → 分镜图片
   - 图片 → 视频

### 🔥 技术亮点

| 技术 | 应用场景 | 优势 |
|------|---------|------|
| DeepSeek Reasoner | 场景分解 | 推理能力强，适合复杂任务 |
| Structured Output Parser | 所有 AI Agent | 确保 JSON 格式正确 |
| Loop Over Items | 批量处理 | 支持大规模场景处理 |
| Wait 节点 | 异步轮询 | 避免阻塞，节省资源 |
| Code 节点 | 数据转换 | 灵活处理复杂逻辑 |

### 📊 性能数据

| 指标 | 数值 |
|------|------|
| 单场景处理时间 | 10-20 分钟 |
| 3 场景处理时间 | 30-60 分钟 |
| API 轮询间隔 | 10 秒 |
| 超时时间 | 10 分钟 |
| 节点总数 | 30+ (主工作流) |
| AI Agent 数量 | 6 个 |

### 💡 对 MATRIX Studio 的启发

1. **工作流编排**:
   - 参考 N8N 的节点连接方式
   - 设计更灵活的工作流编辑器

2. **异步任务管理**:
   - TaskScheduler 可以实现类似的轮询机制
   - 支持后台执行和进度追踪

3. **AI 资产生成**:
   - 集成类似的文生图、图生图、视频生成 API
   - 使用 AssetManager 管理生成的资产

4. **分镜系统**:
   - 参考其场景分解和分镜生成逻辑
   - 为视频工作流提供基础

### 🚀 未来优化方向

1. **并行处理**:
   - 多个场景并行生成
   - 减少总处理时间

2. **缓存机制**:
   - 角色和场景图片缓存
   - 避免重复生成

3. **增量生成**:
   - 支持断点续传
   - 失败场景重新生成

4. **质量控制**:
   - AI 生成结果评分
   - 自动重试低质量结果

---

## 参考链接

- [N8N Import Workflow JSON: Complete Guide](https://latenode.com/blog/low-code-no-code-platforms/n8n-setup-workflows-self-hosting-templates/n8n-import-workflow-json-complete-guide-file-format-examples-2025)
- [N8N Data Structure Documentation](https://docs.n8n.io/data/data-structure/)
- [N8N Export/Import Workflows Guide](https://latenode.com/blog/low-code-no-code-platforms/n8n-setup-workflows-self-hosting-templates/n8n-export-import-workflows-complete-json-guide-troubleshooting-common-failures-2025)

---

**文档版本**: 1.0
**最后更新**: 2026-01-06
**作者**: Claude Code Analysis
