# V0.4.0 模型优先架构修正方案

> **创建时间**: 2026-01-07
> **方案版本**: v2.0 (基于模型优先、Provider路由原则)
> **状态**: 待执行

---

## 一、核心原则

**模型优先、Provider路由**：
- 用户/插件配置**模型名称**（如 "sora-2"），不配置供应商ID
- 系统根据模型自动查询支持的供应商
- 根据优先级/成本/可用性智能选择供应商
- API格式适配器处理不同供应商的调用差异

**架构优势**：
- 供应商灵活切换（Settings中禁用JiekouAI，启用T8Star，插件无需修改）
- 多供应商冗余（JiekouAI限流时自动切换到T8Star）
- 降低耦合（插件不依赖特定供应商实现）

---

## 二、实施任务清单

### 阶段1: API格式适配层构建

#### 任务1.1: 扩展类型定义

**目标文件**: `src/shared/types/api.ts`

**修改位置**: 第37-66行 APIProviderConfig接口

**修改内容**:
```typescript
export interface APIProviderConfig {
  // 基础信息
  id: string;
  name: string;
  category: APICategory;
  baseUrl: string;
  authType: AuthType;
  apiKey?: string;
  enabled: boolean;

  // 新增：API格式标识
  apiFormat: 'openai-compatible' | 'jiekou-custom' | 'comfyui-workflow' | 'custom';

  // 成本估算（可选）
  costPerUnit?: number;
  currency?: string;

  // 高级配置（可选）
  timeout?: number;
  headers?: Record<string, string>;
  models?: string[];  // 该供应商支持的模型列表
  workflowId?: string;

  // 元数据
  description?: string;
  createdAt?: string;
  updatedAt?: string;

  // 状态持久化
  lastStatus?: 'available' | 'unavailable' | 'unknown';
  lastChecked?: string;
  lastLatency?: number;
}
```

**验证标准**: `npm run build` 无TypeScript错误

---

#### 任务1.2: 创建BaseAdapter基类

**目标文件**: `src/main/adapters/BaseAdapter.ts` (新建)

**完整代码**:
```typescript
import { APIProviderConfig, APICallParams } from '@/shared/types/api';

export interface AdapterCallParams {
  provider: APIProviderConfig;
  model: string;
  input: Record<string, unknown>;
}

export abstract class BaseAdapter {
  abstract get supportedFormat(): string;

  abstract callAPI(params: AdapterCallParams): Promise<unknown>;

  protected async fetch(url: string, options: RequestInit): Promise<Response> {
    const response = await fetch(url, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...options.headers,
      },
    });

    if (!response.ok) {
      const error = await response.text();
      throw new Error(`API调用失败: ${response.status} ${error}`);
    }

    return response;
  }

  protected buildAuthHeader(provider: APIProviderConfig): Record<string, string> {
    if (!provider.apiKey) return {};

    switch (provider.authType) {
      case 'bearer':
        return { Authorization: `Bearer ${provider.apiKey}` };
      case 'apikey':
        return { 'X-API-Key': provider.apiKey };
      case 'basic':
        const encoded = Buffer.from(provider.apiKey).toString('base64');
        return { Authorization: `Basic ${encoded}` };
      default:
        return {};
    }
  }
}
```

---

#### 任务1.3: 创建OpenAI兼容适配器

**目标文件**: `src/main/adapters/OpenAICompatibleAdapter.ts` (新建)

**完整代码**:
```typescript
import { BaseAdapter, AdapterCallParams } from './BaseAdapter';

export class OpenAICompatibleAdapter extends BaseAdapter {
  get supportedFormat(): string {
    return 'openai-compatible';
  }

  async callAPI(params: AdapterCallParams): Promise<unknown> {
    const { provider, model, input } = params;
    const { category } = provider;

    if (category === 'llm') {
      return await this.callLLM(provider, model, input);
    } else if (category === 'image-generation') {
      return await this.callImageGeneration(provider, model, input);
    } else if (category === 'video-generation') {
      return await this.callVideoGeneration(provider, model, input);
    }

    throw new Error(`不支持的category: ${category}`);
  }

  private async callLLM(provider, model, input): Promise<{ text: string }> {
    const response = await this.fetch(`${provider.baseUrl}/chat/completions`, {
      method: 'POST',
      headers: this.buildAuthHeader(provider),
      body: JSON.stringify({
        model,
        messages: input.messages,
        temperature: input.temperature ?? 0.7,
        max_tokens: input.maxTokens ?? 2000,
      }),
    });

    const data = await response.json();
    return { text: data.choices[0].message.content };
  }

  private async callImageGeneration(provider, model, input): Promise<{ imageUrl: string }> {
    const response = await this.fetch(`${provider.baseUrl}/images/generations`, {
      method: 'POST',
      headers: this.buildAuthHeader(provider),
      body: JSON.stringify({
        model,
        prompt: input.prompt,
        size: input.size ?? '1024x1024',
        n: 1,
      }),
    });

    const data = await response.json();
    return { imageUrl: data.data[0].url };
  }

  private async callVideoGeneration(provider, model, input): Promise<{ videoUrl: string; taskId?: string }> {
    const response = await this.fetch(`${provider.baseUrl}/videos/generations`, {
      method: 'POST',
      headers: this.buildAuthHeader(provider),
      body: JSON.stringify({
        model,
        prompt: input.prompt,
        image_path: input.imagePath,
      }),
    });

    const data = await response.json();

    if (data.task_id) {
      const finalUrl = await this.pollTaskStatus(provider, data.task_id);
      return { videoUrl: finalUrl, taskId: data.task_id };
    }

    return { videoUrl: data.data[0].url };
  }

  private async pollTaskStatus(provider, taskId: string): Promise<string> {
    const maxAttempts = 60;
    const interval = 10000;

    for (let i = 0; i < maxAttempts; i++) {
      await new Promise(resolve => setTimeout(resolve, interval));

      const response = await this.fetch(`${provider.baseUrl}/tasks/${taskId}`, {
        method: 'GET',
        headers: this.buildAuthHeader(provider),
      });

      const data = await response.json();

      if (data.status === 'succeeded') {
        return data.output.url;
      } else if (data.status === 'failed') {
        throw new Error(`任务失败: ${data.error}`);
      }
    }

    throw new Error('任务超时');
  }
}
```

---

#### 任务1.4: 创建Jiekou自定义适配器

**目标文件**: `src/main/adapters/JiekouCustomAdapter.ts` (新建)

**参考对象**: `plugins/official/novel-to-video/src/services/providers/JiekouAIProvider.ts` 第41-138行

**完整代码**:
```typescript
import { BaseAdapter, AdapterCallParams } from './BaseAdapter';

export class JiekouCustomAdapter extends BaseAdapter {
  get supportedFormat(): string {
    return 'jiekou-custom';
  }

  async callAPI(params: AdapterCallParams): Promise<unknown> {
    const { provider, model, input } = params;
    const { category } = provider;

    if (category === 'image-generation') {
      return await this.callImageGeneration(provider, model, input);
    } else if (category === 'video-generation') {
      return await this.callVideoGeneration(provider, model, input);
    }

    throw new Error(`Jiekou适配器不支持category: ${category}`);
  }

  private async callImageGeneration(provider, model, input): Promise<{ imageUrl: string }> {
    const endpoint = this.getEndpointByModel(model, 'image');

    const response = await this.fetch(endpoint, {
      method: 'POST',
      headers: this.buildAuthHeader(provider),
      body: JSON.stringify({
        prompt: input.prompt,
        image_size: input.size ?? '1024*1024',
        num_inference_steps: 4,
      }),
    });

    const data = await response.json();
    const taskId = data.data.task_id;

    return await this.pollTaskStatus(provider, taskId);
  }

  private async callVideoGeneration(provider, model, input): Promise<{ videoUrl: string }> {
    const endpoint = this.getEndpointByModel(model, 'video');

    const response = await this.fetch(endpoint, {
      method: 'POST',
      headers: this.buildAuthHeader(provider),
      body: JSON.stringify({
        prompt: input.prompt,
        image_url: input.imagePath,
      }),
    });

    const data = await response.json();
    const taskId = data.data.task_id;

    return await this.pollTaskStatus(provider, taskId);
  }

  private getEndpointByModel(model: string, type: 'image' | 'video'): string {
    const endpoints = {
      'z-image-turbo': 'https://api.jiekou.ai/v3/async/z-image-turbo',
      'sora-2': 'https://api.jiekou.ai/v3/async/sora-2-video-reverse',
      'nano-banana-pro': 'https://api.jiekou.ai/v3/nano-banana-pro-light-i2i',
    };

    return endpoints[model] || `https://api.jiekou.ai/v3/async/${model}`;
  }

  private async pollTaskStatus(provider, taskId: string): Promise<{ imageUrl?: string; videoUrl?: string }> {
    const maxAttempts = 60;
    const interval = 10000;

    for (let i = 0; i < maxAttempts; i++) {
      await new Promise(resolve => setTimeout(resolve, interval));

      const response = await this.fetch(`https://api.jiekou.ai/v3/async/fetch/${taskId}`, {
        method: 'POST',
        headers: this.buildAuthHeader(provider),
        body: JSON.stringify({}),
      });

      const data = await response.json();

      if (data.data.status === 'SUCCESS') {
        const url = data.data.output?.[0] || data.data.video_url;
        return data.data.output ? { imageUrl: url } : { videoUrl: url };
      } else if (data.data.status === 'FAILED') {
        throw new Error(`Jiekou任务失败: ${data.data.reason}`);
      }
    }

    throw new Error('Jiekou任务超时');
  }
}
```

---

#### 任务1.5: 创建ComfyUI工作流适配器

**目标文件**: `src/main/adapters/ComfyUIWorkflowAdapter.ts` (新建)

**完整代码**:
```typescript
import { BaseAdapter, AdapterCallParams } from './BaseAdapter';

export class ComfyUIWorkflowAdapter extends BaseAdapter {
  get supportedFormat(): string {
    return 'comfyui-workflow';
  }

  async callAPI(params: AdapterCallParams): Promise<unknown> {
    const { provider, model, input } = params;

    const workflowPayload = {
      prompt: this.buildWorkflowPrompt(input.prompt, model),
      client_id: `matrix-${Date.now()}`,
    };

    const response = await this.fetch(`${provider.baseUrl}/prompt`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(workflowPayload),
    });

    const data = await response.json();
    const promptId = data.prompt_id;

    return await this.pollWorkflowResult(provider, promptId);
  }

  private buildWorkflowPrompt(prompt: string, model: string): Record<string, unknown> {
    return {
      '1': {
        inputs: { text: prompt, model },
        class_type: 'CLIPTextEncode',
      },
      '2': {
        inputs: { samples: ['1', 0] },
        class_type: 'KSampler',
      },
    };
  }

  private async pollWorkflowResult(provider, promptId: string): Promise<{ imageUrl: string }> {
    const maxAttempts = 60;
    const interval = 5000;

    for (let i = 0; i < maxAttempts; i++) {
      await new Promise(resolve => setTimeout(resolve, interval));

      const response = await this.fetch(`${provider.baseUrl}/history/${promptId}`, {
        method: 'GET',
      });

      const data = await response.json();
      const history = data[promptId];

      if (history?.status?.completed) {
        const outputs = history.outputs;
        const imageNode = Object.values(outputs).find((node: any) => node.images);
        if (imageNode) {
          const imagePath = imageNode.images[0].filename;
          return { imageUrl: `${provider.baseUrl}/view?filename=${imagePath}` };
        }
      }
    }

    throw new Error('ComfyUI工作流超时');
  }
}
```

---

### 阶段2: APIManager模型路由重构

#### 任务2.1: 注册适配器和新增callModel方法

**目标文件**: `src/main/services/APIManager.ts`

**修改位置1**: 第1-30行（导入区域）

**新增导入**:
```typescript
import { BaseAdapter } from '../adapters/BaseAdapter';
import { OpenAICompatibleAdapter } from '../adapters/OpenAICompatibleAdapter';
import { JiekouCustomAdapter } from '../adapters/JiekouCustomAdapter';
import { ComfyUIWorkflowAdapter } from '../adapters/ComfyUIWorkflowAdapter';
```

**修改位置2**: 第34-40行（类成员变量）

**新增成员变量**:
```typescript
export class APIManager {
  private providers: Map<string, APIProviderConfig> = new Map();
  private providerStatus: Map<string, APIProviderStatus> = new Map();
  private adapters: Map<string, BaseAdapter> = new Map();  // 新增
  private providersConfigFile: string;
  private encryption: APIKeyEncryption;
```

**修改位置3**: 第154-166行（initialize方法）

**新增适配器注册**:
```typescript
public async initialize(): Promise<void> {
  await logger.info('Initializing APIManager', 'APIManager');

  this.registerAdapters();  // 新增

  await this.ensureConfigDir();
  await this.loadProviders();

  if (this.providers.size === 0) {
    await this.registerDefaultProviders();
  }

  await this.checkAllProvidersHealth();  // 新增

  await logger.info('APIManager initialized', 'APIManager', {
    providerCount: this.providers.size,
  });
}
```

**修改位置4**: 第777行后（新增方法区域）

**新增方法**:
```typescript
private registerAdapters(): void {
  this.adapters.set('openai-compatible', new OpenAICompatibleAdapter());
  this.adapters.set('jiekou-custom', new JiekouCustomAdapter());
  this.adapters.set('comfyui-workflow', new ComfyUIWorkflowAdapter());
}

public async callModel(params: {
  model: string;
  category: APICategory;
  input: Record<string, unknown>;
  providerId?: string;
}): Promise<unknown> {
  const { model, category, input, providerId } = params;

  let targetProvider: APIProviderConfig | undefined;

  if (providerId) {
    targetProvider = this.providers.get(providerId);
    if (!targetProvider) {
      throw new Error(`Provider ${providerId} 不存在`);
    }
  } else {
    const candidates = Array.from(this.providers.values()).filter(
      p => p.enabled && p.category === category && p.models?.includes(model)
    );

    if (candidates.length === 0) {
      throw new Error(`未找到支持模型 ${model} 的 ${category} Provider，请在设置中配置`);
    }

    candidates.sort((a, b) => (b.priority ?? 0) - (a.priority ?? 0));
    targetProvider = candidates[0];
  }

  const adapter = this.adapters.get(targetProvider.apiFormat);
  if (!adapter) {
    throw new Error(`不支持的API格式: ${targetProvider.apiFormat}`);
  }

  await logger.info(`调用模型 ${model}`, 'APIManager', {
    provider: targetProvider.name,
    format: targetProvider.apiFormat,
  });

  return await adapter.callAPI({
    provider: targetProvider,
    model,
    input,
  });
}

private async checkAllProvidersHealth(): Promise<void> {
  const providers = Array.from(this.providers.values());

  for (const provider of providers) {
    try {
      const status = await this.getProviderStatus(provider.id);

      if (status.status === 'unavailable' && provider.enabled) {
        provider.enabled = false;
        await this.addProvider(provider);
        await logger.warn(`Provider ${provider.name} 不可用，已自动禁用`, 'APIManager');
      }
    } catch (error) {
      await logger.error(`健康检查失败: ${provider.name}`, 'APIManager', { error });
    }
  }
}
```

**修改位置5**: 第677-776行（registerDefaultProviders方法）

**为每个Provider新增apiFormat字段**:
```typescript
private async registerDefaultProviders(): Promise<void> {
  const defaults: APIProviderConfig[] = [
    {
      id: 'stability-ai',
      name: 'Stability AI',
      category: APICategory.IMAGE_GENERATION,
      baseUrl: 'https://api.stability.ai/v2beta',
      authType: AuthType.BEARER,
      enabled: false,
      apiFormat: 'openai-compatible',  // 新增
      models: ['sd3-large', 'sd3-medium', 'sdxl'],  // 新增
      createdAt: await timeService.getISOString(),
    },
    {
      id: 't8star',
      name: 'T8Star',
      category: APICategory.IMAGE_GENERATION,
      baseUrl: 'https://ai.t8star.cn/v1',
      authType: AuthType.BEARER,
      enabled: false,
      apiFormat: 'openai-compatible',  // 新增
      models: ['flux-1', 'sd3-large'],  // 新增
      createdAt: await timeService.getISOString(),
    },
  ];

  for (const config of defaults) {
    this.providers.set(config.id, config);
  }
}
```

**验证标准**:
- `npm run build` 无错误
- 调用 `apiManager.callModel({ model: 'sora-2', category: APICategory.VIDEO_GENERATION, input: {...} })` 成功路由到正确Provider

---

### 阶段3: 插件配置去硬编码

#### 任务3.1: 重构default-config.json

**目标文件**: `plugins/official/novel-to-video/default-config.json`

**参考对象**: `docs/Plan/CRITICAL-ARCHITECTURE-PRINCIPLE.md` 第243-257行

**完整替换内容**:
```json
{
  "version": "1.0.0",
  "models": {
    "llm": "gpt-4",
    "imageGeneration": "sd3-large",
    "videoGeneration": "sora-2",
    "tts": null
  },
  "fallbackModels": {
    "llm": ["gpt-3.5-turbo", "deepseek-chat"],
    "imageGeneration": ["flux-1", "sdxl"],
    "videoGeneration": ["runway-gen3"]
  },
  "workflow": {
    "defaultMode": "full-flow",
    "gates": {
      "stage2": ["characterImages", "sceneImages"],
      "stage3": ["sceneSummaries"],
      "stage4": ["storyboards"]
    }
  }
}
```

**验证标准**: 文件中搜索 `"providerId"` 返回0结果

---

#### 任务3.2: NovelVideoAPIService去硬判断

**目标文件**: `plugins/official/novel-to-video/src/services/NovelVideoAPIService.ts`

**修改位置1**: 第99-115行（删除硬编码fallback配置）

**删除代码块**:
```typescript
// 删除整个fallback配置
```

**修改位置2**: 第160-175行（图像生成硬判断）

**替换为**:
```typescript
async generateSceneImage(projectId: string, sceneAssetPath: string): Promise<string> {
  const scene = await this.assetManager.getAsset(sceneAssetPath);
  const prompt = scene.customFields?.novelVideo?.imagePrompt;

  if (!prompt) {
    throw new Error('场景缺少imagePrompt字段');
  }

  const config = await this.getPluginConfig(projectId);
  const model = config.models?.imageGeneration || 'sd3-large';

  const result = await this.apiManager.callModel({
    model,
    category: APICategory.IMAGE_GENERATION,
    input: { prompt, size: '1024x1024' },
  });

  return result.imageUrl;
}
```

**修改位置3**: 第244-268行（视频生成硬判断）

**替换为**:
```typescript
async generateVideo(projectId: string, storyboardAssetPath: string): Promise<string> {
  const storyboard = await this.assetManager.getAsset(storyboardAssetPath);
  const prompt = storyboard.customFields?.novelVideo?.videoPrompt;
  const imagePath = storyboard.customFields?.novelVideo?.referenceImage;

  const config = await this.getPluginConfig(projectId);
  const model = config.models?.videoGeneration || 'sora-2';

  const result = await this.apiManager.callModel({
    model,
    category: APICategory.VIDEO_GENERATION,
    input: { prompt, imagePath },
  });

  return result.videoUrl;
}
```

**修改位置4**: 第465-474行（I2I API硬编码）

**替换为**:
```typescript
async generateImageToImage(params: {
  prompt: string;
  images: string[];
  size?: string;
}): Promise<string> {
  const config = await this.getPluginConfig(this.projectId);
  const model = config.models?.imageGeneration || 'sd3-large';

  const result = await this.apiManager.callModel({
    model,
    category: APICategory.IMAGE_GENERATION,
    input: {
      prompt: params.prompt,
      images: params.images,
      size: params.size ?? '1024*1024',
    },
  });

  return result.imageUrl;
}
```

**验证标准**:
- 搜索文件，确认无 `if (providerId === '` 出现
- 搜索文件，确认无 `process.env.JIEKOU_API_KEY` 出现

---

#### 任务3.3: 删除JiekouAIProvider.ts

**目标文件**: `plugins/official/novel-to-video/src/services/providers/JiekouAIProvider.ts`

**操作**:
```bash
del E:\Projects\Matrix\plugins\official\novel-to-video\src\services\providers\JiekouAIProvider.ts
rmdir E:\Projects\Matrix\plugins\official\novel-to-video\src\services\providers
```

**验证标准**: 目录不存在

---

### 阶段4: 服务扩展

#### 任务4.1: StoryboardService新增场景摘要

**目标文件**: `plugins/official/novel-to-video/src/services/StoryboardService.ts`

**参考对象**: `docs/n8n/Nov2Vid_flow_Analysis.md` 第734-786行

**修改位置**: 第150行后插入

**新增方法**:
```typescript
async generateSceneSummaries(
  projectId: string,
  scenes: SceneAsset[]
): Promise<SceneSummary[]> {
  const summaries: SceneSummary[] = [];
  const config = await this.getPluginConfig(projectId);
  const model = config.models?.llm || 'gpt-4';

  for (const scene of scenes) {
    const prompt = `请为以下场景生成100字左右的摘要，突出视觉要素和情感氛围：\n\n${scene.description}`;

    const result = await this.apiManager.callModel({
      model,
      category: APICategory.LLM,
      input: {
        messages: [{ role: 'user', content: prompt }],
        maxTokens: 200,
      },
    });

    summaries.push({
      sceneId: scene.id,
      summary: result.text,
      createdAt: await timeService.getISOString(),
    });
  }

  return summaries;
}
```

**修改位置2**: 约第200行（generateStoryboard方法签名）

**修改参数**:
```typescript
async generateStoryboard(
  projectId: string,
  scene: SceneAsset,
  previousSummary?: string,
  nextSummary?: string
): Promise<Storyboard> {
  const contextPrompt = previousSummary || nextSummary
    ? `\n【上下文参考】\n前一场景: ${previousSummary || '无'}\n后一场景: ${nextSummary || '无'}`
    : '';

  const config = await this.getPluginConfig(projectId);
  const model = config.models?.llm || 'gpt-4';

  const prompt = `生成场景的分镜脚本：\n${scene.description}${contextPrompt}`;

  const result = await this.apiManager.callModel({
    model,
    category: APICategory.LLM,
    input: {
      messages: [{ role: 'user', content: prompt }],
      maxTokens: 1000,
    },
  });

  return { script: result.text };
}
```

---

#### 任务4.2: ResourceService新增I2I方法

**目标文件**: `plugins/official/novel-to-video/src/services/ResourceService.ts`

**修改位置**: 第200行后插入

**新增方法**:
```typescript
async generateI2IImages(
  projectId: string,
  requests: Array<{ prompt: string; referenceImage: string }>
): Promise<AssetMetadata[]> {
  const results: AssetMetadata[] = [];
  const config = await this.getPluginConfig(projectId);
  const model = config.models?.imageGeneration || 'sd3-large';

  for (const req of requests) {
    try {
      const result = await this.apiManager.callModel({
        model,
        category: APICategory.IMAGE_GENERATION,
        input: {
          prompt: req.prompt,
          images: [req.referenceImage],
          size: '1024*1024',
        },
      });

      const localPath = await this.downloadAsset(result.imageUrl, projectId);

      const asset = await this.assetHelper.createAsset({
        projectId,
        type: AssetType.IMAGE,
        scope: AssetScope.PROJECT,
        filePath: localPath,
        customFields: {
          novelVideo: {
            prompt: req.prompt,
            referenceImage: req.referenceImage,
            generatedAt: await timeService.getISOString(),
          },
        },
      });

      results.push(asset);
    } catch (error) {
      await this.logger.error(`I2I生成失败: ${req.prompt}`, 'ResourceService', { error });
    }
  }

  return results;
}
```

---

### 阶段5: 工作流面板配置化

#### 任务5.1: 创建panel-configs目录和JSON配置

**目标目录**: `plugins/official/novel-to-video/panel-configs/` (新建)

**操作**:
```bash
mkdir E:\Projects\Matrix\plugins\official\novel-to-video\panel-configs
```

**新建文件1**: `chapter-split.json`

**参考对象**: `src/renderer/components/WorkflowPanels/ChapterSplitPanel.tsx`

**完整内容**:
```json
{
  "id": "novel-to-video.chapter-split",
  "title": "章节拆分",
  "description": "使用AI将小说文本拆分为章节和场景",
  "layout": "vertical",
  "fields": [
    {
      "id": "novelText",
      "type": "textarea",
      "label": "小说文本",
      "required": true,
      "placeholder": "粘贴或输入小说文本...",
      "validation": {
        "minLength": 100,
        "maxLength": 50000
      }
    },
    {
      "id": "artStyle",
      "type": "select",
      "label": "艺术风格",
      "required": true,
      "options": [
        { "value": "realistic", "label": "写实风格" },
        { "value": "anime", "label": "动漫风格" },
        { "value": "watercolor", "label": "水彩风格" }
      ],
      "defaultValue": "realistic"
    }
  ],
  "actions": [
    {
      "id": "generate",
      "label": "开始拆分",
      "actionType": "submit",
      "variant": "primary",
      "handler": "executeChapterSplit"
    }
  ],
  "list": {
    "dataSource": "chapters",
    "emptyText": "尚未生成章节，请先执行拆分",
    "itemTemplate": {
      "titleField": "title",
      "tagField": "sceneCount",
      "infoField": "summary"
    }
  }
}
```

**新建文件2-5**: 参考相同结构创建
- `scene-character.json`
- `storyboard.json`
- `voiceover.json`
- `export.json`

**验证标准**: 5个JSON文件存在且格式有效

---

## 三、验收标准

### 功能验收
- [ ] 调用 `apiManager.callModel({ model: 'sora-2', category: VIDEO_GENERATION, input: {...} })` 成功路由
- [ ] Settings中切换Provider（JiekouAI → T8Star），插件自动使用新Provider
- [ ] 启动应用，不可用Provider自动禁用
- [ ] `default-config.json` 中无 `"providerId"` 字段
- [ ] 插件代码中无 `if (providerId === '` 硬判断
- [ ] 插件代码中无 `process.env.JIEKOU_API_KEY` 硬编码

### 质量验收
- [ ] `npm run build` 成功编译
- [ ] `npm run lint` 无错误和警告
- [ ] `npm test` 全部通过

---

## 四、关键文件路径

### 修改文件
```
src/shared/types/api.ts (第37-66行)
src/main/services/APIManager.ts (第1-30行, 34-40行, 154-166行, 677-776行, 777行后)
plugins/official/novel-to-video/default-config.json (完全替换)
plugins/official/novel-to-video/src/services/NovelVideoAPIService.ts (第99-115行, 160-175行, 244-268行, 465-474行)
plugins/official/novel-to-video/src/services/StoryboardService.ts (第150行后, 约第200行)
plugins/official/novel-to-video/src/services/ResourceService.ts (第200行后)
```

### 新增文件
```
src/main/adapters/BaseAdapter.ts
src/main/adapters/OpenAICompatibleAdapter.ts
src/main/adapters/JiekouCustomAdapter.ts
src/main/adapters/ComfyUIWorkflowAdapter.ts
plugins/official/novel-to-video/panel-configs/chapter-split.json
plugins/official/novel-to-video/panel-configs/scene-character.json
plugins/official/novel-to-video/panel-configs/storyboard.json
plugins/official/novel-to-video/panel-configs/voiceover.json
plugins/official/novel-to-video/panel-configs/export.json
```

### 删除文件
```
plugins/official/novel-to-video/src/services/providers/JiekouAIProvider.ts
plugins/official/novel-to-video/src/services/providers/ (目录)
```

---

**方案完成标志**:
- ✅ 所有验收标准通过
- ✅ 插件无硬编码供应商ID
- ✅ API格式适配层完整
- ✅ Provider健康检查完善
- ✅ 工作流面板配置化完成
