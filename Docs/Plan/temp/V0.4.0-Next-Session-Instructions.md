# V0.4.0 Novel-to-Video 修正方案 - 新对话启动指令

> **创建时间**: 2026-01-07
> **上下文状态**: 前一个对话上下文不足6%，需新对话重新设计
> **任务状态**: 架构原则已确认，等待基于正确架构重新设计修正方案

---

## 📋 背景说明

前一个对话在设计修正方案时，出现了**根本性的架构理解错误**：
- ❌ 错误：将 JiekouAI 当作核心对象，提取 `JiekouAIProvider.ts`
- ❌ 错误：认为 Provider = 供应商
- ✅ 正确：**Provider = 路由层**，核心是**模型**而非供应商

经过完整讨论和纠错后，用户确认了正确的架构原则（详见必读文档1）。

---

## 🎯 新对话任务

**任务**：基于"**模型优先、Provider 路由**"原则，重新设计 V0.4.0 修正方案

**目标**：
1. 修正插件硬编码问题（模型配置代替供应商 ID）
2. 实现 Provider 智能路由（模型 → 供应商自动匹配）
3. 支持供应商灵活切换（无需修改插件代码）
4. 实现 API 格式适配层（OpenAI、Jiekou、ComfyUI 格式）
5. 完成 5 个工作流面板的 JSON 配置化

---

## 📚 必读文档（按顺序）

### 1. 核心架构原则（⚠️ 最高优先级）
```
docs/Plan/CRITICAL-ARCHITECTURE-PRINCIPLE.md
```

**关键概念**：
- 用户关注：我要用 **Sora2 模型**生成视频（不关心从哪个供应商调用）
- 插件配置：指定模型名称 `"videoGeneration": "sora-2"`
- Provider 路由：查询支持 Sora2 的供应商（JiekouAI / T8 / ComfyUI）
- 智能选择：根据成本/速度/可用性选择供应商
- API 适配：调用该供应商的 API 格式

**架构示例**：
- 同一模型可通过多个供应商访问：Sora2 ← JiekouAI / T8 / ComfyUI
- 供应商配置包含支持的模型列表：`"models": ["sora-2", "sd3-large", ...]`
- APIManager 统一路由：`callModel({ model: "sora-2", ... })` → 自动选择供应商

### 2. 完整对话历史（问题解答）
```
docs/Plan/V0.4.0-Discussion-History.md
```

**内容**：
- Q1-Q3：Provider 全局化架构（统一路由、不是供应商特定实现）
- Q4-Q6：UI 架构（先 MVP、资产管理基于 project.json）
- Q7-Q12：配置管理、实施策略、技术细节
- 最终纠错：模型优先于供应商的根本原则

### 3. 原始设计文档
```
docs/Plan/V0.4.0-Nov2Vid-modify-Plan.md
```

**关键章节**：
- 第4.4节：Provider 永远是全局的
- 第4.3节：UI 接驳的预期方案
- 第三、五节：架构隔离策略、新增模块清单

### 4. 错误方案（仅供参考）
```
docs/Plan/V0.4.0-Novel-to-Video-Architecture-Fix.md（❌ 已废弃）
```

**错误点**：
- 任务1.1：迁移 JiekouAIProvider 到全局 ← **错误**（不应该提取特定供应商）
- 正确做法：创建统一的 API 适配器层，而不是供应商特定实现

---

## 🔧 正确的架构设计要点

### 核心文件结构（应该存在的）

```
src/main/services/
├── APIManager.ts                    # 统一路由和模型调度
├── adapters/                        # API 格式适配器
│   ├── OpenAIFormatAdapter.ts       # OpenAI 兼容格式
│   ├── JiekouFormatAdapter.ts       # Jiekou AI 自定义格式
│   └── ComfyUIFormatAdapter.ts      # ComfyUI Workflow 格式
└── ModelRegistry.ts                 # 模型注册表

config/
└── providers.json                   # 供应商配置列表
```

### 插件配置（关注模型）

```json
{
  "models": {
    "llm": "gpt-4",
    "imageGeneration": "sd3-large",
    "videoGeneration": "sora-2"
  },
  "fallbackModels": {
    "llm": ["gpt-3.5-turbo", "deepseek-chat"],
    "videoGeneration": ["runway-gen3"]
  }
}
```

### Provider 配置（供应商 + 模型列表）

```json
{
  "id": "jiekou-ai",
  "name": "JiekouAI",
  "type": "relay",
  "baseUrl": "https://api.jiekou.ai",
  "apiFormat": "jiekou-custom",
  "models": ["sora-2", "sd3-large", "gpt-4"],
  "apiKey": "...",
  "priority": 10
}
```

### APIManager 核心方法

```typescript
class APIManager {
  /**
   * 调用模型（自动路由到合适的供应商）
   */
  async callModel(params: {
    model: string;              // 模型名称（如 "sora-2"）
    category: APICategory;
    input: unknown;
  }): Promise<unknown> {
    // 1. 查询支持该模型的供应商
    const providers = this.findProvidersByModel(params.model);

    // 2. 智能选择供应商（优先级/成本/速度）
    const selected = this.selectOptimalProvider(providers);

    // 3. 根据供应商的 API 格式调用适配器
    return await this.callWithAdapter(selected, params);
  }

  private async callWithAdapter(provider, params) {
    const adapter = this.getAdapter(provider.apiFormat);
    return await adapter.call(provider, params);
  }
}
```

---

## 🚀 实施任务清单

基于正确架构，新对话需要完成的任务：

### 阶段1: 统一模型路由（核心）
- [ ] 修改 `default-config.json`：删除 `providerId`，改为 `models` 配置
- [ ] 扩展 `APIManager.callModel()`：模型 → 供应商路由逻辑
- [ ] 创建 API 适配器层：`JiekouFormatAdapter.ts`、`OpenAIFormatAdapter.ts`
- [ ] 修改 `NovelVideoAPIService.ts`：所有调用改为 `callModel({ model: "sora-2" })`

### 阶段2: Provider 配置增强
- [ ] `config/providers.json`：每个供应商添加 `models` 字段
- [ ] Settings UI：Provider 管理界面支持模型列表编辑
- [ ] 健康检查：自动检测供应商对特定模型的可用性

### 阶段3: 智能路由策略
- [ ] 按优先级路由（用户配置）
- [ ] 按成本路由（最便宜供应商）
- [ ] 故障转移（供应商不可用时自动切换）

### 阶段4: UI 职责修复
- [ ] PluginConfigTab：显示模型需求，不显示供应商选择
- [ ] Settings/Provider 管理：全局供应商和模型列表管理

### 阶段5: Panel 配置化
- [ ] 创建 6 个工作流面板的 JSON 配置（与之前方案相同）

---

## ✅ 验收标准

### 功能验收
- [ ] 插件配置仅指定模型（无供应商 ID）
- [ ] 在 Settings 中切换供应商，插件自动路由
- [ ] 同一模型支持多供应商（JiekouAI ↔ T8 ↔ ComfyUI）
- [ ] 供应商不可用时自动降级到备选供应商

### 代码验收
- [ ] 插件目录无硬编码的供应商 ID（如 `"jiekou-ai-t2i"`）
- [ ] 无 `JiekouAIProvider.ts` 等供应商特定实现文件
- [ ] 存在统一的 `adapters/` 目录和 API 格式适配器

---

## 📝 新对话执行步骤

1. **阅读必读文档**（30分钟）：
   - 重点理解 `CRITICAL-ARCHITECTURE-PRINCIPLE.md`
   - 浏览 `V0.4.0-Discussion-History.md` 的 Q1-Q12 解答

2. **进入计划模式**：
   ```
   请进入计划模式，基于以上文档，重新设计 V0.4.0 修正方案
   ```

3. **设计方案**：
   - 核心：模型优先、Provider 路由
   - 结构：APIManager + 适配器层
   - 删除：所有供应商特定实现

4. **生成可执行计划**：
   - 精确到文件路径和行号
   - 每个任务包含参考对象和验证标准
   - 保存到 `docs/Plan/V0.4.0-Model-First-Architecture-Fix.md`

---

## 🔑 关键提醒

1. **不要提取 JiekouAIProvider.ts**（这是错误的）
2. **Provider ≠ 供应商**（Provider = 路由层）
3. **插件配置模型，系统路由供应商**
4. **同一模型可通过多个供应商访问**
5. **智能选择供应商，自动降级**

---

**新对话启动命令**：
```
我已阅读 docs/Plan/V0.4.0-Next-Session-Instructions.md。
请进入计划模式，基于"模型优先、Provider 路由"原则，重新设计 V0.4.0 修正方案。
```
