# V0.4.0 - N8N 工作流逻辑融入 Novel-to-Video 插件实施计划

> **版本**: v0.4.0
> **创建时间**: 2026-01-06
> **状态**: 设计完成，待实施

---

## 一、核心目标

将 N8N AI漫剧工作流的完整逻辑融入现有 `novel-to-video` 插件，实现：

1. **一键化生成**: 配置后自动执行全流程
2. **流程控制**: 可控制每阶段细节，支持单独步骤生成、补全缺失项、一键全自动三种模式
3. **灵活切换**: 可随时更换外部 API 供应商（Provider永远是全局的）
4. **物料管理**: 使用现有左侧抽屉（UnifiedAssetPanel）展示和管理物料
5. **进度追踪**: 保存工作流进度JSON文件，支持版本管理和缺失项补全

### 实施策略
- **最大化复用**: 90% 复用现有服务（ChapterService、StoryboardService、AsyncTaskManager等）
- **最小化侵入**: 仅新增 2 个核心模块（WorkflowExecutor、MaterialCollector）
- **插件级隔离**: 不修改主进程核心服务
- **配置驱动**: 通过全局ConfigManager控制异步轮询参数

### 现有基础设施（无需新增）
- ✅ **AsyncTaskManager**: 10秒轮询、10分钟超时、重试机制（src/main/services/AsyncTaskManager.ts）
- ✅ **ProgressOrb**: 潮汐注水动画进度球（src/renderer/components/common/ProgressOrb.tsx）
- ✅ **QueueTab**: 任务队列实时显示（src/renderer/components/global/tabs/QueueTab.tsx）
- ✅ **三种生成模式**: current/auto-complete/full-flow（GlobalRightPanel已实现）

---

## 二、N8N 工作流分析

### 2.1 工作流阶段

```
Stage 1: AI场景分解
  输入: story + art_style
  AI: DeepSeek Reasoner + Structured Output
  输出: scenes[] + characters[]

Stage 2: 并行物料生成
  分支A: 角色图片生成（AI生成prompt → 文生图API → 异步轮询）
  分支B: 场景图片生成（同上）
  输出: character_list[] + scene_list[]

Stage 2.5: 场景摘要生成（新增阶段）
  逐个场景生成100字摘要
  生成整章摘要
  输出: scene_summaries[] + chapter_summary

Stage 3: 分镜脚本生成
  输入: 场景、角色、场景摘要（previousSummary/nextSummary）
  AI链式调用: 生成视频分镜脚本 + 图片分镜脚本
  输出: video_storyboards[] + image_storyboards[]

Stage 4: 批量资产生成
  批量生成分镜图片（图生图API，同步）
  批量生成视频片段（视频生成API，异步轮询，10分钟超时）
  输出: 最终视频和图片资产
```

### 2.2 关键技术机制

- **异步轮询**: 10-15秒间隔（全局可配置），10分钟超时，单次任务超时5分钟后重试3次
- **批量串行处理**: Loop Over Items（逐个处理，无并发）
- **结构化输出**: LangChainAgent.structuredOutput() + Zod Schema
- **阀门机制**: 同阶段任务独立执行（1个失败不影响其他），跨阶段需检查所有必要产出
- **版本管理**: 同一资产可有多个版本，最新版本自动成为默认选择

---

## 三、架构设计

### 3.1 核心模块（需新增）

**WorkflowExecutor** (200-300行):
- 职责: 4阶段+Stage2.5主编排器
- 关键方法:
  - `executeFullWorkflow(params)`: 完整流程执行
  - `executeStage(stageId, context)`: 单阶段执行
  - `checkGateCondition(stageId)`: 阀门检查
- 依赖: ChapterService, StoryboardService, ResourceService, MaterialCollector
- 参考: N8N主工作流节点连接逻辑（docs/n8n/Nov2Vid_flow_Analysis.md:927-1051行）

**MaterialCollector** (150-200行):
- 职责: 收集工作流产物，生成进度JSON
- 关键方法:
  - `collectStageOutput(stageId, outputs)`: 收集单阶段产出
  - `generateProgressFile(workflowId)`: 生成进度文件
  - `getMissingItems()`: 获取缺失项列表
- 输出文件: `projects/{projectId}/workflow-progress-{workflowId}.json`
- 参考: 进度文件结构（本文档4.2节）

**JiekouAIProvider** (100-150行):
- 职责: Jiekou AI的3个API封装
- 注册位置: APIManager全局Provider（IMAGE_GENERATION/VIDEO_GENERATION分类）
- API端点:
  - POST /v3/async/z-image-turbo (文生图，异步)
  - POST /v3/nano-banana-pro-light-i2i (图生图，同步)
  - POST /v3/async/sora-2-video-reverse (视频生成，异步)
- 参考: APIManager.registerProvider()方法

### 3.2 服务扩展（已有文件修改）

**StoryboardService** (plugins/official/novel-to-video/src/services/StoryboardService.ts):
- 新增方法1: `generateSceneSummaries(scenes: Scene[]): Promise<SceneSummary[]>`
  - 目的: Stage 2.5，为每个场景生成100字摘要
  - 位置: 第150行后插入
  - 参考: N8N工作流步骤19-24（docs/n8n/Nov2Vid_flow_Analysis.md:734-786行）
- 新增方法2: `generateContextualScript(scene, previousSummary, nextSummary)`
  - 目的: 传入上下文生成分镜脚本
  - 位置: 修改现有generateScript方法签名
  - 参考: N8N工作流步骤29（docs/n8n/Nov2Vid_flow_Analysis.md:812-823行）

**ResourceService** (plugins/official/novel-to-video/src/services/ResourceService.ts):
- 新增方法: `generateI2IImages(prompts[], referenceImages[]): Promise<Asset[]>`
  - 目的: 批量图生图（使用Jiekou AI的I2I API）
  - 位置: 第200行后插入
  - 轮询机制: 复用AsyncTaskManager.executeWithPolling()
  - 参考: N8N子工作流2（docs/n8n/Nov2Vid_flow_Analysis.md:196-284行）

**NovelVideoAPIService** (plugins/official/novel-to-video/src/services/NovelVideoAPIService.ts):
- 修改: 在构造函数中注册JiekouAIProvider到全局APIManager
- 位置: 第50行constructor内添加registerProvider调用
- 检验: 调用后window.electronAPI.listProviders()应包含"jiekou-ai"

---

## 四、关键技术决策

### 4.1 异步轮询配置（使用现有AsyncTaskManager）

**当前状态**:
- ✅ AsyncTaskManager已实现（src/main/services/AsyncTaskManager.ts）
- ✅ 默认轮询间隔: 10秒
- ✅ 默认超时: 10分钟
- ✅ 重试机制: executeWithRetry()方法

**需要添加的ConfigManager配置** (src/main/services/ConfigManager.ts):
```typescript
// 第141行DEFAULT_CONFIG中新增
async: {
  pollInterval: 10000,     // 10秒
  pollTimeout: 600000,     // 10分钟
  maxRetries: 3
}
```

**修改位置**:
- 文件: src/main/services/ConfigManager.ts
- 行号: 第141-179行（DEFAULT_CONFIG对象）
- 检验: 调用getConfig('async.pollInterval')返回10000

### 4.2 工作流进度文件（问题4解决方案）

**文件位置**: `projects/{projectId}/workflow-progress-{workflowId}.json`

**文件结构**:
```json
{
  "workflowId": "uuid",
  "projectId": "uuid",
  "createdAt": "2026-01-06T10:00:00Z",
  "updatedAt": "2026-01-06T10:35:00Z",

  "stages": {
    "stage2": {
      "status": "partial",  // completed | partial | failed | blocked
      "canProceedToNext": false,  // 阀门条件
      "outputs": {
        "characterImages": [
          {
            "id": "character-主角",
            "required": true,
            "versions": [
              {
                "assetId": "asset-001",
                "status": "success",
                "createdAt": "2026-01-06T10:10:00Z",
                "isDefault": false
              },
              {
                "assetId": "asset-002",
                "status": "success",
                "createdAt": "2026-01-06T10:20:00Z",
                "isDefault": true  // 最新版本 = 默认
              }
            ]
          },
          {
            "id": "character-配角B",
            "required": true,
            "versions": [],
            "status": "missing",
            "lastError": "任务超时",
            "failedAt": "2026-01-06T10:35:00Z"
          }
        ]
      }
    }
  },

  "missingItems": [
    {
      "stage": "stage2",
      "type": "characterImages",
      "id": "character-配角B",
      "reason": "timeout",
      "required": true
    }
  ],

  "gateConditions": {
    "stage2": {
      "requiredOutputs": ["character-主角", "character-配角A", "character-配角B"],
      "actualOutputs": ["character-主角", "character-配角A"],
      "canProceed": false
    }
  }
}
```

**三种生成模式**（已在GlobalRightPanel实现）:
1. **current**: 单独步骤生成（执行特定Stage）
2. **auto-complete**: 补全缺失项（读取missingItems，仅生成缺失物料）
3. **full-flow**: 一键全自动（完整4阶段，遇阀门关闭则停止）

**阀门机制**:
- 同阶段任务互不阻塞（3个角色任务，1个失败不影响另外2个）
- 跨阶段检查：所有必要产出存在才能开启下一阀门
- 失败任务不支持checkpoint恢复（API是异步的，失败就重新提交新任务）

### 4.3 物料管理UI（复用现有组件）

**已完成的UI组件**:
- ✅ **UnifiedAssetPanel**: 左侧抽屉，项目TAB展示物料
  - 位置: src/renderer/components/UnifiedAssetPanel/
  - 现有分类: 章节、场景、角色、分镜脚本、配音
  - 需扩展: 场景摘要、分镜图、最终视频（修改types.ts）
- ✅ **GlobalRightPanel**: 右侧面板，已有三种生成模式
  - 位置: src/renderer/components/global/GlobalRightPanel.tsx
  - 模式: current、auto-complete、full-flow（第70行）
- ✅ **QueueTab**: 任务队列实时显示
  - 位置: src/renderer/components/global/tabs/QueueTab.tsx
  - 功能: 运行中/已完成/失败任务列表，每3秒刷新
- ✅ **ProgressOrb**: 潮汐注水进度球
  - 位置: src/renderer/components/common/ProgressOrb.tsx
  - 功能: 半圆形、Y轴拖动、点击打开队列Tab

**可选扩展**（非必需）:
- ⚠️ 版本管理UI: UnifiedAssetPanel卡片右上角显示版本徽章
- ⚠️ 缺失项提示: 空白卡片+"补全"按钮

### 4.4 Provider架构（问题2解决方案）

**Provider永远是全局的**:
- 所有Provider注册在APIManager（IMAGE_GENERATION、VIDEO_GENERATION分类）
- Jiekou AI、T8Star、ComfyUI都是全局Provider，用户可随时切换

**插件配置仅引用**:
```json
// default-config.json
{
  "workflow": {
    "providers": {
      "imageProvider": {
        "providerId": "jiekou-ai",  // 仅引用，不含实现
        "category": "IMAGE_GENERATION"
      },
      "videoProvider": {
        "providerId": "jiekou-ai",
        "category": "VIDEO_GENERATION"
      }
    }
  }
}
```

软件架构 = **物料管理**（AssetManager）+ **路由调配**（APIManager）
插件 = **逻辑编排模板**

---

## 五、实施文件清单

### 5.1 新增文件（6个）

| 文件路径 | 职责 | 代码量 | 优先级 |
|---------|------|-------|--------|
| `services/WorkflowExecutor.ts` | 4阶段+Stage2.5主编排器 | 200-300行 | P0 |
| `services/MaterialCollector.ts` | 物料收集和进度文件生成 | 150-200行 | P0 |
| `services/providers/JiekouAIProvider.ts` | Jiekou AI的3个API封装 | 100-150行 | P0 |
| `types/workflow.ts` | 工作流类型定义（WorkflowContext等） | 50-80行 | P0 |
| `schemas/workflow-progress.ts` | 进度文件Schema | 30-50行 | P1 |
| `tests/integration/workflow.test.ts` | 端到端集成测试 | 100-150行 | P1 |

### 5.2 修改文件（4个插件文件 + 1个全局配置）

| 文件路径 | 修改内容 | 修改位置 | 检验标准 |
|---------|---------|---------|---------|
| `services/StoryboardService.ts` | 新增generateSceneSummaries()方法 | 第150行后插入 | 调用返回SceneSummary[] |
| `services/ResourceService.ts` | 新增generateI2IImages()方法 | 第200行后插入 | 调用Jiekou I2I API成功 |
| `services/NovelVideoAPIService.ts` | 构造函数注册JiekouAIProvider | 第50行constructor内 | listProviders()含"jiekou-ai" |
| `default-config.json` | 新增workflow.providers配置节 | 第30行后插入 | 包含imageProvider/videoProvider |
| `src/main/services/ConfigManager.ts` | 新增async配置节 | 第141行DEFAULT_CONFIG | getConfig('async.pollInterval')=10000 |

---

## 六、实施步骤（分6个Phase）

### Phase 1: 类型定义和Provider注册
**任务**:
1. 创建 `types/workflow.ts`
   - 定义: WorkflowContext, StageOutput, GateCondition
   - 参考: 本文档4.2节进度文件结构
2. 创建 `services/providers/JiekouAIProvider.ts`
   - 实现3个API方法: textToImage(), imageToImage(), videoGeneration()
   - 注册到APIManager: category为IMAGE_GENERATION/VIDEO_GENERATION
3. 修改 `default-config.json`
   - 新增workflow.providers配置节
   - 仅引用providerId，不含实现

**检验标准**:
- `npm run build` 无TypeScript错误
- 调用 `listProviders()` 包含 "jiekou-ai"
- default-config.json包含workflow.providers.imageProvider

### Phase 2: 服务扩展
**任务**:
1. 扩展 `StoryboardService.ts`
   - 新增generateSceneSummaries()方法（第150行后）
   - 修改generateScript()签名，接受previousSummary/nextSummary
   - 参考: N8N工作流步骤19-24和29
2. 扩展 `ResourceService.ts`
   - 新增generateI2IImages()方法（第200行后）
   - 使用AsyncTaskManager.executeWithPolling()
3. 修改 `NovelVideoAPIService.ts`
   - 构造函数内调用registerProvider()
4. 修改 `ConfigManager.ts`
   - DEFAULT_CONFIG新增async配置节

**检验标准**:
- 调用generateSceneSummaries()返回SceneSummary[]
- 调用generateI2IImages()成功请求Jiekou I2I API
- getConfig('async.pollInterval')返回10000

### Phase 3: 工作流编排器
**任务**:
1. 创建 `services/WorkflowExecutor.ts`
   - 实现executeFullWorkflow()方法
   - 实现executeStage()方法
   - 实现checkGateCondition()方法
   - 依赖ChapterService、StoryboardService、ResourceService
   - 参考: N8N主工作流完整执行流程（docs/n8n/Nov2Vid_flow_Analysis.md:927-1051行）
2. 创建 `services/MaterialCollector.ts`
   - 实现collectStageOutput()方法
   - 实现generateProgressFile()方法
   - 实现getMissingItems()方法

**检验标准**:
- 调用executeFullWorkflow()执行完4阶段+Stage2.5
- 生成workflow-progress-{workflowId}.json文件
- 文件包含stages、missingItems、gateConditions字段

### Phase 4: 进度Schema和分类扩展
**任务**:
1. 创建 `schemas/workflow-progress.ts`
   - 定义WorkflowProgressSchema（Zod）
   - 验证进度文件JSON结构
2. 修改 `UnifiedAssetPanel/types.ts`
   - 扩展AssetCategory: 场景摘要、分镜图、最终视频

**检验标准**:
- WorkflowProgressSchema.parse()验证通过
- UnifiedAssetPanel支持新分类显示

### Phase 5: 集成测试
**任务**:
1. 创建 `tests/integration/workflow.test.ts`
   - 测试完整4阶段执行
   - 测试阀门机制（缺失项阻塞）
   - 测试auto-complete模式

**检验标准**:
- `npm run test:integration` 全部通过
- 测试覆盖率 >80%

### Phase 6: 文档和验收
**任务**:
1. 更新CHANGELOG.md
2. 执行本文档第七节验收标准
3. 提交commit

**检验标准**:
- 所有验收标准通过
- ESLint 0 errors, 0 warnings

---

## 七、验收标准（Checklist）

### 核心功能验收
- [ ] **完整流程执行**: executeFullWorkflow()成功执行4阶段+Stage2.5
- [ ] **阶段独立执行**: executeStage('stage2')单独执行成功
- [ ] **三种生成模式**: current/auto-complete/full-flow均可用（GlobalRightPanel已实现）
- [ ] **Provider注册**: listProviders()包含"jiekou-ai"，分类正确
- [ ] **进度文件生成**: workflow-progress-{workflowId}.json包含所需字段
- [ ] **阀门机制**: 缺失必要产出时阻塞下一阶段
- [ ] **异步轮询**: AsyncTaskManager使用ConfigManager配置的轮询间隔
- [ ] **物料分类**: UnifiedAssetPanel显示场景摘要/分镜图/最终视频

### 质量验收
- [ ] **构建成功**: `npm run build` 无错误
- [ ] **类型检查**: `npm run typecheck` 通过
- [ ] **代码规范**: `npm run lint` 0 errors, 0 warnings
- [ ] **集成测试**: `npm run test:integration` 通过，覆盖率>80%
- [ ] **文档完整**: CHANGELOG.md包含v0.4.0变更记录

### 可选扩展（非必需）
- [ ] 版本管理UI: UnifiedAssetPanel卡片右上角版本徽章
- [ ] 缺失项提示: QueueTab顶部"缺失N项物料"横幅

---

## 八、关键文件路径（所有路径为绝对路径）

### 新增文件（6个）
```
E:\Projects\Matrix\plugins\official\novel-to-video\src\
├── services\
│   ├── WorkflowExecutor.ts              (新增, 200-300行)
│   ├── MaterialCollector.ts             (新增, 150-200行)
│   └── providers\
│       └── JiekouAIProvider.ts          (新增, 100-150行)
├── types\
│   └── workflow.ts                      (新增, 50-80行)
├── schemas\
│   └── workflow-progress.ts             (新增, 30-50行)
└── tests\
    └── integration\
        └── workflow.test.ts             (新增, 100-150行)
```

### 修改文件（5个）
```
E:\Projects\Matrix\plugins\official\novel-to-video\src\
├── services\
│   ├── StoryboardService.ts             (扩展, 第150行后插入)
│   ├── ResourceService.ts               (扩展, 第200行后插入)
│   └── NovelVideoAPIService.ts          (扩展, 第50行constructor内)
└── default-config.json                  (扩展, 第30行后插入)

E:\Projects\Matrix\src\main\services\ConfigManager.ts  (扩展, 第141行DEFAULT_CONFIG)
```

### 已有基础设施（无需修改）
```
E:\Projects\Matrix\src\
├── main\services\
│   └── AsyncTaskManager.ts              (已有, 轮询机制)
└── renderer\components\
    ├── common\ProgressOrb.tsx           (已有, 潮汐进度球)
    └── global\
        ├── GlobalRightPanel.tsx         (已有, 三种模式)
        └── tabs\QueueTab.tsx            (已有, 任务队列)
```

---

## 九、参考资料（按查阅顺序）

### 必读文档
1. **N8N工作流完整分析**: `docs/n8n/Nov2Vid_flow_Analysis.md`
   - 主工作流执行流程: 第927-1051行
   - Stage 2.5场景摘要: 第734-786行
   - 图生图子流程: 第196-284行
   - 视频生成子流程: 第287-416行

2. **现有插件源码**: `plugins/official/novel-to-video/src/`
   - ChapterService: 场景分解和角色提取
   - StoryboardService: 4步链式AI调用
   - ResourceService: 资源生成和批量处理
   - NovelVideoAPIService: API封装

### 关键全局服务
3. **AsyncTaskManager**: `src/main/services/AsyncTaskManager.ts`
   - executeWithPolling()方法: 异步轮询实现
4. **APIManager**: `src/main/services/APIManager.ts`
   - registerProvider()方法: Provider注册
5. **ConfigManager**: `src/main/services/ConfigManager.ts`
   - DEFAULT_CONFIG: 第141-179行

---

**文档版本**: v1.1（修正版）
**修正日期**: 2026-01-06
**文档状态**: ✅ 已修正，待实施
