# V0.4.0 测试用例设计文档

> **创建时间**: 2026-01-07
> **目标**: 为 V0.4.0 架构改造提供完整的测试验收清单
> **用途**: 改造完成后逐项验证，确保无遗漏

---

## 一、测试文件清单（7个）

| 序号 | 文件路径 | 用例数 | 测试目标 | 预计耗时 |
|------|---------|--------|---------|---------|
| 1 | `tests/unit/adapters/BaseAdapter.test.ts` | 5 | Adapter基类接口定义 | 0.2秒 |
| 2 | `tests/unit/adapters/OpenAICompatibleAdapter.test.ts` | 10 | OpenAI格式API适配 | 0.5秒 |
| 3 | `tests/unit/adapters/AsyncPollingAdapter.test.ts` | 10 | 异步轮询机制 | 1.0秒 |
| 4 | `tests/unit/adapters/ComfyUIWorkflowAdapter.test.ts` | 8 | ComfyUI工作流适配 | 0.4秒 |
| 5 | `tests/integration/adapters/adapter-routing.test.ts` | 5 | Adapter路由集成 | 0.5秒 |
| 6 | `tests/integration/novel-video/stage4-video-generation.test.ts` | 4 | Stage 4视频生成 | 0.8秒 |
| 7 | `tests/unit/services/APIManager.test.ts` (扩展) | 7 | callModel路由逻辑 | 0.6秒 |
| **总计** | **7个文件** | **49个用例** | - | **4.0秒** |

---

## 二、测试用例详细清单（49个）

### 2.1 BaseAdapter.test.ts（5个用例）

**测试目标**: 验证Adapter基类的抽象接口定义

| 编号 | 用例名称 | 测试目标 | 预期结果 |
|------|---------|---------|---------|
| 1.1 | 应该定义supportedFormat抽象属性 | 验证子类必须实现此属性 | 抽象属性存在 |
| 1.2 | 应该定义callAPI抽象方法 | 验证子类必须实现此方法 | 抽象方法存在 |
| 1.3 | 应该提供fetch辅助方法 | 验证基类提供HTTP请求封装 | fetch方法可用 |
| 1.4 | 应该提供buildAuthHeader方法 | 验证认证头构建逻辑 | 正确构建Authorization头 |
| 1.5 | 子类不实现抽象成员时报错 | 验证TypeScript类型检查 | 编译时错误 |

---

### 2.2 OpenAICompatibleAdapter.test.ts（10个用例）

**测试目标**: 验证OpenAI兼容格式API调用

| 编号 | 用例名称 | 测试目标 | 预期结果 |
|------|---------|---------|---------|
| 2.1 | supportedFormat应该返回'openai-compatible' | 验证格式标识 | 返回正确字符串 |
| 2.2 | 应该正确构建LLM chat/completions请求 | 验证请求体结构 | 包含model, messages, temperature等 |
| 2.3 | 应该正确解析LLM响应 | 验证响应提取 | 返回 { text: '...' } |
| 2.4 | 应该正确调用图像生成API | 验证图像生成请求 | 返回 { imageUrl: '...' } |
| 2.5 | 应该正确调用视频生成API | 验证视频生成请求 | 返回 { videoUrl: '...', taskId: '...' } |
| 2.6 | 应该处理HTTP 401错误 | 验证认证失败处理 | 抛出AuthenticationError |
| 2.7 | 应该处理HTTP 429限流 | 验证限流处理 | 抛出RateLimitError |
| 2.8 | 应该处理HTTP 500服务错误 | 验证服务器错误处理 | 抛出ServerError |
| 2.9 | 应该处理网络超时 | 验证超时处理 | 抛出TimeoutError |
| 2.10 | 应该处理JSON解析错误 | 验证响应格式错误 | 抛出ParseError |

---

### 2.3 AsyncPollingAdapter.test.ts（10个用例）

**测试目标**: 验证异步轮询机制

| 编号 | 用例名称 | 测试目标 | 预期结果 |
|------|---------|---------|---------|
| 3.1 | supportedFormat应该返回'async-polling' | 验证格式标识 | 返回正确字符串 |
| 3.2 | 应该正确映射sora-2到sora-2-video-reverse | 验证模型名称映射 | 映射正确 |
| 3.3 | 应该对未知模型返回原名 | 验证未映射模型处理 | 返回原始名称 |
| 3.4 | 应该成功提交异步任务 | 验证任务提交 | 返回taskId |
| 3.5 | 应该成功轮询任务状态（2次PROCESSING后SUCCEED） | 验证轮询流程 | 正确轮询3次 |
| 3.6 | 应该处理轮询超时（60次后） | 验证超时机制 | 抛出TimeoutError |
| 3.7 | 应该处理任务失败状态（FAILED） | 验证失败处理 | 抛出TaskFailedError |
| 3.8 | 应该正确计算轮询间隔（5秒） | 验证轮询间隔 | 每次间隔5秒 |
| 3.9 | 应该处理任务提交失败 | 验证提交错误 | 抛出SubmitError |
| 3.10 | 应该处理状态查询网络错误 | 验证轮询错误恢复 | 重试后成功/失败 |

---

### 2.4 ComfyUIWorkflowAdapter.test.ts（8个用例）

**测试目标**: 验证ComfyUI工作流适配

| 编号 | 用例名称 | 测试目标 | 预期结果 |
|------|---------|---------|---------|
| 4.1 | supportedFormat应该返回'comfyui-workflow' | 验证格式标识 | 返回正确字符串 |
| 4.2 | 应该正确构建ComfyUI工作流Prompt | 验证工作流构建 | Prompt结构正确 |
| 4.3 | 应该成功提交工作流 | 验证工作流提交 | 返回promptId |
| 4.4 | 应该成功轮询工作流结果 | 验证结果获取 | 返回imageUrl |
| 4.5 | 应该处理工作流执行失败 | 验证失败处理 | 抛出WorkflowError |
| 4.6 | 应该处理工作流超时 | 验证超时处理 | 抛出TimeoutError |
| 4.7 | 应该支持自定义client_id | 验证客户端ID | 使用matrix-前缀 |
| 4.8 | 应该处理WebSocket连接失败 | 验证连接错误 | 降级到HTTP轮询 |

---

### 2.5 adapter-routing.test.ts（5个用例）

**测试目标**: 验证Adapter路由集成

| 编号 | 用例名称 | 测试目标 | 预期结果 |
|------|---------|---------|---------|
| 5.1 | sora-2应该路由到最高优先级Provider | 验证优先级路由 | 选择templateRecommended的Provider |
| 5.2 | 切换Provider后应该使用新配置 | 验证动态路由 | 禁用后自动切换 |
| 5.3 | 本地ComfyUI模型应该使用ComfyUIWorkflowAdapter | 验证格式路由 | 正确选择Adapter |
| 5.4 | 未找到Provider时应该抛出明确错误 | 验证错误处理 | 错误信息包含模型名 |
| 5.5 | 多Provider并发调用应该互不干扰 | 验证并发安全 | 10个并发调用成功 |

---

### 2.6 stage4-video-generation.test.ts（4个用例）

**测试目标**: 验证Stage 4视频生成完整性

| 编号 | 用例名称 | 测试目标 | 预期结果 |
|------|---------|---------|---------|
| 6.1 | executeStage4应该生成分镜图片和视频 | 验证完整输出 | 包含storyboardImages和videoSegments |
| 6.2 | 应该在无Stage 3输出时失败 | 验证依赖检查 | 抛出'Stage 3输出不存在'错误 |
| 6.3 | 应该正确调用generateStoryboardVideo | 验证方法调用 | ResourceService方法被调用 |
| 6.4 | checkGateCondition应该验证videoSegments | 验证阀门更新 | stage4阀门包含videoSegments |

---

### 2.7 APIManager.test.ts（7个扩展用例）

**测试目标**: 验证callModel路由逻辑

| 编号 | 用例名称 | 测试目标 | 预期结果 |
|------|---------|---------|---------|
| 7.1 | callModel应该根据模型名称路由到正确Provider | 验证模型路由 | 选择支持该模型的Provider |
| 7.2 | callModel找不到Provider时抛出明确错误 | 验证错误处理 | 错误信息包含模型和category |
| 7.3 | callModel应该根据providerId直接调用 | 验证直接调用 | 跳过路由，使用指定Provider |
| 7.4 | callModel应该根据apiFormat选择OpenAICompatibleAdapter | 验证Adapter选择 | 使用正确Adapter |
| 7.5 | callModel应该根据apiFormat选择AsyncPollingAdapter | 验证Adapter选择 | 使用正确Adapter |
| 7.6 | callModel应该根据apiFormat选择ComfyUIWorkflowAdapter | 验证Adapter选择 | 使用正确Adapter |
| 7.7 | callModel应该处理Adapter调用失败 | 验证错误传播 | 正确抛出Adapter错误 |

---

## 三、测试数据需求

### 3.1 Mock API响应数据（录制-回放模式）

**文件位置**: `tests/fixtures/api-responses/`

| 文件名 | 用途 | 来源 | 状态 |
|--------|------|------|------|
| `sora-2-success.json` | 视频生成成功响应 | JiekouAI真实API | 待录制 |
| `sora-2-processing.json` | 视频生成处理中 | JiekouAI真实API | 待录制 |
| `sora-2-failed.json` | 视频生成失败 | JiekouAI真实API | 待录制 |
| `z-image-turbo-success.json` | 图像生成成功响应 | JiekouAI真实API | 待录制 |
| `nano-banana-success.json` | 图生图成功响应 | T8Star真实API | 待录制 |
| `comfyui-workflow-success.json` | 工作流执行成功 | ComfyUI真实API | 待录制 |
| `openai-chat-success.json` | LLM对话成功响应 | OpenAI真实API | 待录制 |

**录制命令**（首次执行）：
```bash
# 配置真实API Key
export JIEKOU_API_KEY="your-key"
export T8STAR_API_KEY="your-key"

# 运行录制脚本
npm run test:adapters:record
```

### 3.2 基线快照数据（复用现有）

**文件位置**: `tests/snapshots/phase7-baseline/`

| 文件名 | 用途 | 状态 |
|--------|------|------|
| `output-chapters.json` | Stage 1章节输出 | ✅ 已存在 |
| `output-scenes.json` | Stage 1场景输出 | ✅ 已存在 |
| `output-characters.json` | Stage 1角色输出 | ✅ 已存在 |
| `output-stage3.json` | Stage 3分镜输出 | ✅ 已存在 |
| `output-stage4.json` | **Stage 4完整输出** | ⚠️ 待新增 |

**待新增快照结构**（`output-stage4.json`）：
```json
{
  "description": "Stage 4完整输出结构",
  "expectedOutputs": {
    "storyboardImages": [
      {
        "id": "storyboard-image-1",
        "prompt": "...",
        "referenceImages": [],
        "filePath": "/path/to/image.png"
      }
    ],
    "videoSegments": [
      {
        "id": "video-segment-1",
        "storyboardId": "storyboard-1",
        "prompt": "...",
        "filePath": "/path/to/video.mp4",
        "duration": 10
      }
    ]
  },
  "gateConditions": ["storyboardImages", "videoSegments"]
}
```

### 3.3 Mock配置数据

**文件位置**: `tests/fixtures/configs/`

| 文件名 | 用途 | 状态 |
|--------|------|------|
| `provider-jiekou-ai.json` | JiekouAI Provider配置 | 待创建 |
| `provider-t8star.json` | T8Star Provider配置 | 待创建 |
| `provider-comfyui.json` | ComfyUI Provider配置 | 待创建 |
| `plugin-config-v0.4.0.json` | Novel-to-Video插件配置 | 待创建 |

---

## 四、验收标准

### 4.1 功能验收（7项）

- [ ] **路由测试**: callModel()根据模型名称正确路由到Provider
- [ ] **Adapter选择**: 根据apiFormat正确选择3种Adapter
- [ ] **异步轮询**: AsyncPollingAdapter正确处理PROCESSING → SUCCEED流程
- [ ] **超时处理**: 轮询60次后正确抛出TimeoutError
- [ ] **错误传播**: Adapter错误正确传播到调用方
- [ ] **Stage 4视频**: executeStage4正确输出videoSegments
- [ ] **并发安全**: 10个并发callModel调用互不干扰

### 4.2 覆盖率目标（3项）

| 目标文件 | 当前覆盖率 | 目标覆盖率 | 增量 |
|---------|-----------|-----------|------|
| `src/main/services/APIManager.ts` | 24% | ≥ 60% | +36% |
| `src/main/adapters/*.ts` (新增) | 0% | ≥ 80% | +80% |
| `plugins/.../WorkflowExecutor.ts` | 未知 | ≥ 70% | - |

**验证命令**：
```bash
npm run test:coverage
```

### 4.3 回归验证（4项）

- [ ] 现有38个APIManager单元测试全部通过
- [ ] 现有18个api-model IPC测试全部通过
- [ ] 现有workflow.test.ts全部通过
- [ ] 现有phase7-baseline.test.ts全部通过

**验证命令**：
```bash
npm test
```

### 4.4 性能验收（2项）

- [ ] 新增49个测试用例总耗时 ≤ 5秒
- [ ] 单个测试用例耗时 ≤ 200ms（除轮询测试外）

**验证命令**：
```bash
npm test -- --reporter=verbose
```

---

## 五、测试执行检查清单

### 5.1 准备阶段（改造前）

- [ ] 运行 `npm test` 确认现有测试全部通过
- [ ] 记录当前测试覆盖率（基线）
- [ ] 准备API录制环境（.env.test配置）
- [ ] 创建测试数据目录结构

### 5.2 开发阶段（改造中）

- [ ] 按P0顺序创建Adapter层（步骤1-3）
- [ ] 按P0顺序清理插件层（步骤4-6）
- [ ] 按P1顺序扩展服务层（步骤7-9）
- [ ] 每完成一项修改，运行对应测试

### 5.3 验证阶段（改造后）

- [ ] 创建7个测试文件
- [ ] 编写49个测试用例
- [ ] 运行 `npm test` 验证全部通过
- [ ] 运行 `npm run test:coverage` 验证覆盖率
- [ ] 运行 `npm run build` 验证构建成功
- [ ] 运行 `npm run lint` 验证代码质量

### 5.4 交叉验证（最终检查）

- [ ] 对照本文档逐项检查49个用例
- [ ] 检查是否遗漏测试场景
- [ ] 验证测试数据完整性（7个API响应 + 1个快照）
- [ ] 确认所有验收标准达成

---

## 六、风险与注意事项

### 6.1 测试数据风险

**风险**: 真实API调用可能失败（网络、配额限制）

**缓解措施**:
- 首次录制前检查API Key有效性
- 录制失败时保留部分mock数据作为备份
- 考虑使用VCR库自动录制HTTP交互

### 6.2 异步测试风险

**风险**: Fake Timers可能导致测试不稳定

**缓解措施**:
- 使用 `vi.advanceTimersByTimeAsync()` 而非 `vi.runAllTimers()`
- 每个测试后调用 `vi.useRealTimers()` 清理
- 轮询测试单独隔离，避免影响其他测试

### 6.3 集成测试风险

**风险**: Stage 4测试依赖Stage 1-3输出

**缓解措施**:
- 使用基线快照而非真实执行前置Stage
- 确保快照数据与实际输出结构一致
- 定期更新快照数据

---

## 附录：测试用例编号索引

| 编号 | 测试文件 | 用例名称 |
|------|---------|---------|
| 1.1-1.5 | BaseAdapter.test.ts | Adapter基类接口（5个） |
| 2.1-2.10 | OpenAICompatibleAdapter.test.ts | OpenAI格式适配（10个） |
| 3.1-3.10 | AsyncPollingAdapter.test.ts | 异步轮询机制（10个） |
| 4.1-4.8 | ComfyUIWorkflowAdapter.test.ts | ComfyUI工作流（8个） |
| 5.1-5.5 | adapter-routing.test.ts | 路由集成（5个） |
| 6.1-6.4 | stage4-video-generation.test.ts | Stage 4视频（4个） |
| 7.1-7.7 | APIManager.test.ts (扩展) | callModel路由（7个） |

**总计**: 49个测试用例
