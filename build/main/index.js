(()=>{"use strict";var e={896(e){e.exports=require("fs")}},t={};function i(s){var a=t[s];if(void 0!==a)return a.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,i),r.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const s=require("electron"),a=require("path");class r{constructor(){this.mainWindow=null}createMainWindow(){const{width:e,height:t}=s.screen.getPrimaryDisplay().workAreaSize;return this.mainWindow=new s.BrowserWindow({width:Math.min(1200,e-100),height:Math.min(800,t-100),minWidth:800,minHeight:600,webPreferences:{nodeIntegration:!1,contextIsolation:!0,preload:a.join(__dirname,"preload.js")},icon:a.join(__dirname,"../../resources/icons/icon.png"),show:!1,titleBarStyle:"darwin"===process.platform?"hiddenInset":"default"}),this.mainWindow.loadFile(a.join(__dirname,"../renderer/index.html")),this.mainWindow.once("ready-to-show",()=>{this.mainWindow&&(this.mainWindow.show(),this.mainWindow.focus())}),this.mainWindow.on("closed",()=>{this.mainWindow=null}),this.mainWindow}getMainWindow(){return this.mainWindow}closeMainWindow(){this.mainWindow&&this.mainWindow.close()}minimizeMainWindow(){this.mainWindow&&this.mainWindow.minimize()}maximizeMainWindow(){this.mainWindow&&(this.mainWindow.isMaximized()?this.mainWindow.unmaximize():this.mainWindow.maximize())}isMainWindowMaximized(){return!!this.mainWindow&&this.mainWindow.isMaximized()}}class n{constructor(){this.channels=new Map}register(e,t){this.channels.has(e)||this.channels.set(e,[]),this.channels.get(e).push(t)}unregister(e,t){const i=this.channels.get(e);if(i){const e=i.indexOf(t);e>-1&&i.splice(e,1)}}getHandlers(e){return this.channels.get(e)||[]}clear(){this.channels.clear()}}const o=require("fs/promises"),c=require("crypto");var l=i.n(c);const h=new Uint8Array(256);let g=h.length;function d(){return g>h.length-16&&(l().randomFillSync(h),g=0),h.slice(g,g+=16)}const w=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,m=[];for(let e=0;e<256;++e)m.push((e+256).toString(16).substr(1));const p=function(e,t=0){const i=(m[e[t+0]]+m[e[t+1]]+m[e[t+2]]+m[e[t+3]]+"-"+m[e[t+4]]+m[e[t+5]]+"-"+m[e[t+6]]+m[e[t+7]]+"-"+m[e[t+8]]+m[e[t+9]]+"-"+m[e[t+10]]+m[e[t+11]]+m[e[t+12]]+m[e[t+13]]+m[e[t+14]]+m[e[t+15]]).toLowerCase();if(!function(e){return"string"==typeof e&&w.test(e)}(i))throw TypeError("Stringified UUID is invalid");return i},u=function(e,t,i){const s=(e=e||{}).random||(e.rng||d)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){i=i||0;for(let e=0;e<16;++e)t[i+e]=s[e];return t}return p(s)},f=require("child_process"),A=(0,require("util").promisify)(f.exec);class y{constructor(){this.lastSyncTime=null,this.timeDriftThreshold=5e3,this.ntpServers=["pool.ntp.org","time.nist.gov","time.google.com"]}static getInstance(){return y.instance||(y.instance=new y),y.instance}async getCurrentTime(){const e=new Date;return await this.logTimeOperation("getCurrentTime",e),e}async getUTCTime(){return(await this.getCurrentTime()).toISOString()}async getLocalTime(){return(await this.getCurrentTime()).toLocaleString()}async syncWithNTP(){try{for(const e of this.ntpServers)try{if(await this.syncWithNTPServer(e))return this.lastSyncTime=await this.getCurrentTime(),await this.logTimeOperation("syncWithNTP",this.lastSyncTime,{server:e}),!0}catch(t){console.warn(`NTP同步失败 ${e}:`,t)}return this.lastSyncTime=await this.getCurrentTime(),await this.logTimeOperation("syncWithNTP_fallback",this.lastSyncTime),!1}catch(e){return console.error("NTP同步过程中发生错误:",e),!1}}async validateTimeIntegrity(){try{const e=await this.getCurrentTime(),t=Date.now(),i=Math.abs(e.getTime()-t);if(i>this.timeDriftThreshold)return console.warn(`检测到时间偏差: ${i}ms`),!1;if(this.lastSyncTime){const t=e.getTime()-this.lastSyncTime.getTime();if(t>3e5)return console.warn(`时间同步过期: ${t}ms`),!1}return await this.logTimeOperation("validateTimeIntegrity",e,{isValid:!0}),!0}catch(e){return console.error("时间验证失败:",e),!1}}async syncWithNTPServer(e){try{const t=process.platform;if("win32"===t)await A("w32tm /resync /force");else if("darwin"===t)await A(`sntp -sS ${e}`);else if("linux"===t)try{await A(`ntpdate -u ${e}`)}catch{await A("chronyc sources || chronyc makestep")}return!0}catch(t){return console.error(`与NTP服务器 ${e} 同步失败:`,t),!1}}async logTimeOperation(e,t,i){const s={level:"info",message:`时间操作: ${e}`,timestamp:t.toISOString(),service:"TimeService",operation:e,data:i||{}};console.log("TimeService Log:",JSON.stringify(s,null,2))}static requireValidTime(){return function(e,t,i){if(!i)return;const s=i.value;return i.value=async function(...e){const i=y.getInstance();if(!await i.validateTimeIntegrity()&&!await i.syncWithNTP())throw new Error(`时间验证失败，无法执行操作: ${String(t)}`);return s.apply(this,e)},i}}}class T{static getInstance(){return T.instance||(T.instance=new T),T.instance}async validateTimeOperation(e){const t=y.getInstance(),i=await t.getCurrentTime();try{const s=await t.getCurrentTime();return this.logTimeOperation(e,i,s),!0}catch(t){return console.error(`时间操作验证失败: ${e}`,t),!1}}logTimeOperation(e,t,i){const s=i.getTime()-t.getTime(),a={level:"info",message:`时间操作监控: ${e}`,timestamp:i.toISOString(),service:"TimeMonitor",operation:e,duration:`${s}ms`,startTime:t.toISOString(),endTime:i.toISOString()};console.log("TimeMonitor Log:",JSON.stringify(a,null,2))}}const P=y.getInstance();T.getInstance();class E{constructor(){this.projects=new Map,this.isInitialized=!1,this.projectsPath=a.join(process.cwd(),"projects")}async initialize(){try{await o.mkdir(this.projectsPath,{recursive:!0}),await this.loadAllProjects(),this.isInitialized=!0,this.log("info","项目管理器初始化完成")}catch(e){const t={code:"PROJECT_MANAGER_INIT_FAILED",message:`项目管理器初始化失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"ProjectManager",operation:"initialize"};throw this.log("error",t.message,t),t}}async cleanup(){try{await this.saveAllProjects(),this.projects.clear(),this.isInitialized=!1,this.log("info","项目管理器清理完成")}catch(e){const t={code:"PROJECT_MANAGER_CLEANUP_FAILED",message:`项目管理器清理失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"ProjectManager",operation:"cleanup"};throw this.log("error",t.message,t),t}}async createProject(e,t){if(!await P.validateTimeIntegrity()&&!await P.syncWithNTP())throw new Error("时间验证失败，无法执行操作: createProject");if(!this.isInitialized)throw new Error("项目管理器未初始化");try{const i=u(),s=a.join(this.projectsPath,i);await o.mkdir(s,{recursive:!0});const r=await P.getCurrentTime(),n={id:i,name:e,path:s,createdAt:r,updatedAt:r,settings:{defaultWorkflow:t||"default",outputFormat:"mp4",quality:80},workflows:[],assets:[]};return t&&await this.applyTemplate(s,t),await this.saveProjectConfig(n),this.projects.set(i,n),this.log("info",`项目创建成功: ${e} (${i})`),n}catch(e){const t={code:"PROJECT_CREATE_FAILED",message:`创建项目失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"ProjectManager",operation:"createProject"};throw this.log("error",t.message,t),t}}async loadProject(e){if(!await P.validateTimeIntegrity()&&!await P.syncWithNTP())throw new Error("时间验证失败，无法执行操作: loadProject");if(!this.isInitialized)throw new Error("项目管理器未初始化");try{if(this.projects.has(e))return this.projects.get(e);const t=a.join(this.projectsPath,e,"project.json"),i=await o.readFile(t,"utf-8"),s=JSON.parse(i);return s.createdAt=new Date(s.createdAt),s.updatedAt=new Date(s.updatedAt),this.projects.set(e,s),this.log("info",`项目加载成功: ${e}`),s}catch(e){const t={code:"PROJECT_LOAD_FAILED",message:`加载项目失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"ProjectManager",operation:"loadProject"};throw this.log("error",t.message,t),t}}async saveProject(e,t){if(!await P.validateTimeIntegrity()&&!await P.syncWithNTP())throw new Error("时间验证失败，无法执行操作: saveProject");if(!this.isInitialized)throw new Error("项目管理器未初始化");try{t.updatedAt=await P.getCurrentTime(),await this.saveProjectConfig(t),this.projects.set(e,t),this.log("info",`项目保存成功: ${e}`)}catch(e){const t={code:"PROJECT_SAVE_FAILED",message:`保存项目失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"ProjectManager",operation:"saveProject"};throw this.log("error",t.message,t),t}}async deleteProject(e){if(!await P.validateTimeIntegrity()&&!await P.syncWithNTP())throw new Error("时间验证失败，无法执行操作: deleteProject");if(!this.isInitialized)throw new Error("项目管理器未初始化");try{const t=this.projects.get(e);if(!t)throw new Error(`项目不存在: ${e}`);await o.rm(t.path,{recursive:!0,force:!0}),this.projects.delete(e),this.log("info",`项目删除成功: ${e}`)}catch(e){const t={code:"PROJECT_DELETE_FAILED",message:`删除项目失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"ProjectManager",operation:"deleteProject"};throw this.log("error",t.message,t),t}}async listProjects(){if(!await P.validateTimeIntegrity()&&!await P.syncWithNTP())throw new Error("时间验证失败，无法执行操作: listProjects");if(!this.isInitialized)throw new Error("项目管理器未初始化");try{const e=Array.from(this.projects.values());return this.log("info",`列出项目: ${e.length} 个项目`),e}catch(e){const t={code:"PROJECT_LIST_FAILED",message:`列出项目失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"ProjectManager",operation:"listProjects"};throw this.log("error",t.message,t),t}}async linkGlobalAsset(e,t){if(!await P.validateTimeIntegrity()&&!await P.syncWithNTP())throw new Error("时间验证失败，无法执行操作: linkGlobalAsset");if(!this.isInitialized)throw new Error("项目管理器未初始化");try{const i=this.projects.get(e);if(!i)throw new Error(`项目不存在: ${e}`);const s=a.join(i.path,"links",`${t}.json`);await o.mkdir(a.dirname(s),{recursive:!0}),await o.writeFile(s,JSON.stringify({globalAssetId:t,linkedAt:(await P.getCurrentTime()).toISOString()}),"utf-8"),this.log("info",`全局资产链接成功: ${t} -> ${e}`)}catch(e){const t={code:"PROJECT_LINK_ASSET_FAILED",message:`链接全局资产失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"ProjectManager",operation:"linkGlobalAsset"};throw this.log("error",t.message,t),t}}async getLinkedAssets(e){if(!await P.validateTimeIntegrity()&&!await P.syncWithNTP())throw new Error("时间验证失败，无法执行操作: getLinkedAssets");if(!this.isInitialized)throw new Error("项目管理器未初始化");try{const t=this.projects.get(e);if(!t)throw new Error(`项目不存在: ${e}`);const i=a.join(t.path,"links"),s=[];try{const e=await o.readdir(i);for(const t of e)t.endsWith(".json")&&(JSON.parse(await o.readFile(a.join(i,t),"utf-8")),s.push({}))}catch{}return this.log("info",`获取链接资产: ${e}, 数量: ${s.length}`),s}catch(e){const t={code:"PROJECT_GET_LINKED_ASSETS_FAILED",message:`获取链接资产失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"ProjectManager",operation:"getLinkedAssets"};throw this.log("error",t.message,t),t}}async loadAllProjects(){try{const e=await o.readdir(this.projectsPath,{withFileTypes:!0});for(const t of e)if(t.isDirectory())try{await this.loadProject(t.name)}catch(e){this.log("warn",`跳过无效项目目录: ${t.name}, 错误: ${e}`)}}catch(e){this.log("warn",`加载项目目录失败: ${e}`)}}async saveAllProjects(){try{const e=Array.from(this.projects.values()).map(e=>this.saveProjectConfig(e));await Promise.all(e)}catch(e){this.log("error",`批量保存项目失败: ${e}`)}}async saveProjectConfig(e){const t=a.join(e.path,"project.json");await o.mkdir(a.dirname(t),{recursive:!0}),await o.writeFile(t,JSON.stringify(e,null,2),"utf-8")}async applyTemplate(e,t){const i=a.join(e,"templates",t);await o.mkdir(i,{recursive:!0}),this.log("info",`应用项目模板: ${t} -> ${e}`)}log(e,t,i){new Date,console.log(`[ProjectManager] ${e.toUpperCase()}: ${t}`,i||"")}}var v,M,j,I,$;new E,function(e){e.TEXT="text",e.IMAGE="image",e.VIDEO="video",e.AUDIO="audio",e.MODEL="model",e.WORKFLOW="workflow"}(v||(v={})),function(e){e.PROJECT="project",e.GLOBAL="global"}(M||(M={})),function(e){e.OFFICIAL="official",e.PARTNER="partner",e.COMMUNITY="community"}(j||(j={})),function(e){e.FILE_SYSTEM_READ="file-system:read",e.FILE_SYSTEM_WRITE="file-system:write",e.NETWORK_ANY="network:any",e.NETWORK_OFFICIAL_API="network:official-api",e.SHELL_EXEC="shell:exec"}(I||(I={})),function(e){e.PENDING="pending",e.RUNNING="running",e.COMPLETED="completed",e.FAILED="failed",e.CANCELLED="cancelled"}($||($={}));class S{constructor(){this.projectAssets=new Map,this.globalAssets=new Map,this.isInitialized=!1,this.projectsPath=a.join(process.cwd(),"projects"),this.globalAssetsPath=a.join(process.cwd(),"global-assets")}async initialize(){try{await o.mkdir(this.projectsPath,{recursive:!0}),await o.mkdir(this.globalAssetsPath,{recursive:!0}),await this.loadAllAssets(),this.isInitialized=!0,this.log("info","资产管理器初始化完成")}catch(e){const t={code:"ASSET_MANAGER_INIT_FAILED",message:`资产管理器初始化失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"AssetManager",operation:"initialize"};throw this.log("error",t.message,t),t}}async cleanup(){try{await this.saveAllAssets(),this.projectAssets.clear(),this.globalAssets.clear(),this.isInitialized=!1,this.log("info","资产管理器清理完成")}catch(e){const t={code:"ASSET_MANAGER_CLEANUP_FAILED",message:`资产管理器清理失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"AssetManager",operation:"cleanup"};throw this.log("error",t.message,t),t}}async addAsset(e,t){if(!await P.validateTimeIntegrity()&&!await P.syncWithNTP())throw new Error("时间验证失败，无法执行操作: addAsset");if(!this.isInitialized)throw new Error("资产管理器未初始化");try{const i=t.id||u(),s=await P.getCurrentTime(),a={id:i,scope:e.scope,type:t.type||v.TEXT,path:t.path||"",metadata:t.metadata||{},aiAttributes:t.aiAttributes,tags:t.tags||[],createdAt:s,updatedAt:s,...t};return await this.saveAssetConfig(e.scope,e.id,a),e.scope===M.PROJECT?(this.projectAssets.has(e.id)||this.projectAssets.set(e.id,new Map),this.projectAssets.get(e.id).set(i,a)):this.globalAssets.set(i,a),this.log("info",`资产添加成功: ${i} (${e.scope}:${e.id})`),a}catch(e){const t={code:"ASSET_ADD_FAILED",message:`添加资产失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"AssetManager",operation:"addAsset"};throw this.log("error",t.message,t),t}}async getAsset(e,t,i){if(!await P.validateTimeIntegrity()&&!await P.syncWithNTP())throw new Error("时间验证失败，无法执行操作: getAsset");if(!this.isInitialized)throw new Error("资产管理器未初始化");try{if(e===M.PROJECT){const e=this.projectAssets.get(t);if(e&&e.has(i))return e.get(i)}else if(this.globalAssets.has(i))return this.globalAssets.get(i);const s=await this.loadAssetConfig(e,t,i);return e===M.PROJECT?(this.projectAssets.has(t)||this.projectAssets.set(t,new Map),this.projectAssets.get(t).set(i,s)):this.globalAssets.set(i,s),this.log("info",`资产获取成功: ${i} (${e}:${t})`),s}catch(e){const t={code:"ASSET_GET_FAILED",message:`获取资产失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"AssetManager",operation:"getAsset"};throw this.log("error",t.message,t),t}}async promoteAssetToGlobal(e,t,i){if(!await P.validateTimeIntegrity()&&!await P.syncWithNTP())throw new Error("时间验证失败，无法执行操作: promoteAssetToGlobal");if(!this.isInitialized)throw new Error("资产管理器未初始化");try{const s={...await this.getAsset(M.PROJECT,e,t),scope:M.GLOBAL,updatedAt:await P.getCurrentTime()};await this.saveAssetConfig(M.GLOBAL,i,s),this.globalAssets.set(t,s);const r=a.join(this.globalAssetsPath,"promotions",`${t}.json`);return await o.mkdir(a.dirname(r),{recursive:!0}),await o.writeFile(r,JSON.stringify({assetId:t,projectId:e,category:i,promotedAt:s.updatedAt.toISOString()}),"utf-8"),this.log("info",`资产提升成功: ${t} (${e} -> global:${i})`),s}catch(e){const t={code:"ASSET_PROMOTE_FAILED",message:`提升资产失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"AssetManager",operation:"promoteAssetToGlobal"};throw this.log("error",t.message,t),t}}async removeAsset(e,t,i){if(!await P.validateTimeIntegrity()&&!await P.syncWithNTP())throw new Error("时间验证失败，无法执行操作: removeAsset");if(!this.isInitialized)throw new Error("资产管理器未初始化");try{const s=await this.getAsset(e,t,i);if(await o.rm(s.path,{recursive:!0,force:!0}),e===M.PROJECT){const e=this.projectAssets.get(t);e&&e.delete(i)}else this.globalAssets.delete(i);this.log("info",`资产删除成功: ${i} (${e}:${t})`)}catch(e){const t={code:"ASSET_REMOVE_FAILED",message:`删除资产失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"AssetManager",operation:"removeAsset"};throw this.log("error",t.message,t),t}}async updateAsset(e,t,i,s){if(!await P.validateTimeIntegrity()&&!await P.syncWithNTP())throw new Error("时间验证失败，无法执行操作: updateAsset");if(!this.isInitialized)throw new Error("资产管理器未初始化");try{const a={...await this.getAsset(e,t,i),...s,updatedAt:await P.getCurrentTime()};if(await this.saveAssetConfig(e,t,a),e===M.PROJECT){const e=this.projectAssets.get(t);e&&e.set(i,a)}else this.globalAssets.set(i,a);this.log("info",`资产更新成功: ${i} (${e}:${t})`)}catch(e){const t={code:"ASSET_UPDATE_FAILED",message:`更新资产失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"AssetManager",operation:"updateAsset"};throw this.log("error",t.message,t),t}}async searchAssets(e,t,i){if(!await P.validateTimeIntegrity()&&!await P.syncWithNTP())throw new Error("时间验证失败，无法执行操作: searchAssets");if(!this.isInitialized)throw new Error("资产管理器未初始化");try{let s=[];if(e===M.PROJECT){const e=this.projectAssets.get(t);e&&(s=Array.from(e.values()))}else s=Array.from(this.globalAssets.values());let a=s;if(i.type&&(a=a.filter(e=>e.type===i.type)),i.tags&&i.tags.length>0&&(a=a.filter(e=>i.tags.some(t=>e.tags.includes(t)))),i.text){const e=i.text.toLowerCase();a=a.filter(t=>t.path.toLowerCase().includes(e)||t.tags.some(t=>t.toLowerCase().includes(e)))}i.dateRange&&(a=a.filter(e=>e.createdAt>=i.dateRange.start&&e.createdAt<=i.dateRange.end));const r=i.offset||0,n=i.limit||a.length,o=a.slice(r,r+n);return this.log("info",`资产搜索完成: ${e}:${t}, 结果数量: ${o.length}`),o}catch(e){const t={code:"ASSET_SEARCH_FAILED",message:`搜索资产失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"AssetManager",operation:"searchAssets"};throw this.log("error",t.message,t),t}}async getAssetPreview(e,t,i){if(!await P.validateTimeIntegrity()&&!await P.syncWithNTP())throw new Error("时间验证失败，无法执行操作: getAssetPreview");if(!this.isInitialized)throw new Error("资产管理器未初始化");try{const s=await this.getAsset(e,t,i);let a;switch(s.type){case v.IMAGE:a=s.path.replace(/(\.[^.]+)$/,"_preview$1");break;case v.VIDEO:case v.AUDIO:a=s.path.replace(/(\.[^.]+)$/,"_preview.jpg");break;default:a=s.path}try{return await o.access(a),a}catch{return s.path}}catch(e){const t={code:"ASSET_PREVIEW_FAILED",message:`获取资产预览失败: ${e instanceof Error?e.message:String(e)}`,timestamp:await P.getCurrentTime(),service:"AssetManager",operation:"getAssetPreview"};throw this.log("error",t.message,t),t}}async loadAllAssets(){try{const e=await o.readdir(this.projectsPath,{withFileTypes:!0});for(const t of e)if(t.isDirectory())try{const e=a.join(this.projectsPath,t.name,"assets"),i=await o.readdir(e);this.projectAssets.has(t.name)||this.projectAssets.set(t.name,new Map);for(const s of i)if(s.endsWith(".json"))try{const i=JSON.parse(await o.readFile(a.join(e,s),"utf-8")),r={...i,createdAt:new Date(i.createdAt),updatedAt:new Date(i.updatedAt)};this.projectAssets.get(t.name).set(r.id,r)}catch(e){this.log("warn",`跳过无效资产文件: ${s}, 错误: ${e}`)}}catch(e){this.log("warn",`加载项目资产失败: ${t.name}, 错误: ${e}`)}try{const e=await o.readdir(this.globalAssetsPath);for(const t of e)if(t.endsWith(".json"))try{const e=JSON.parse(await o.readFile(a.join(this.globalAssetsPath,t),"utf-8")),i={...e,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)};this.globalAssets.set(i.id,i)}catch(e){this.log("warn",`跳过无效全局资产文件: ${t}, 错误: ${e}`)}}catch(e){this.log("warn",`加载全局资产失败: ${e}`)}}catch(e){this.log("error",`加载资产失败: ${e}`)}}async saveAllAssets(){try{for(const[e,t]of this.projectAssets.entries()){const i=a.join(this.projectsPath,e,"assets");await o.mkdir(i,{recursive:!0});const s=Array.from(t.values()).map(t=>this.saveAssetConfig(M.PROJECT,e,t));await Promise.all(s)}const e=Array.from(this.globalAssets.values()).map(e=>this.saveAssetConfig(M.GLOBAL,"global",e));await Promise.all(e)}catch(e){this.log("error",`批量保存资产失败: ${e}`)}}async saveAssetConfig(e,t,i){let s;s=e===M.PROJECT?a.join(this.projectsPath,t,"assets",`${i.id}.json`):a.join(this.globalAssetsPath,`${i.id}.json`),await o.mkdir(a.dirname(s),{recursive:!0}),await o.writeFile(s,JSON.stringify(i,null,2),"utf-8")}async loadAssetConfig(e,t,i){let s;s=e===M.PROJECT?a.join(this.projectsPath,t,"assets",`${i}.json`):a.join(this.globalAssetsPath,`${i}.json`);const r=await o.readFile(s,"utf-8"),n=JSON.parse(r);return n.createdAt=new Date(n.createdAt),n.updatedAt=new Date(n.updatedAt),n}log(e,t,i){new Date,console.log(`[AssetManager] ${e.toUpperCase()}: ${t}`,i||"")}}new S,new class{constructor(){this.windowManager=new r,this.ipcManager=new n,this.projectManager=new E,this.assetManager=new S,this.initializeEventListeners()}initializeEventListeners(){s.app.whenReady().then(()=>{this.onReady()}),s.app.on("window-all-closed",()=>{"darwin"!==process.platform&&s.app.quit()}),s.app.on("activate",()=>{0===s.BrowserWindow.getAllWindows().length&&this.windowManager.createMainWindow()}),s.app.on("before-quit",async()=>{await this.cleanup()})}async onReady(){try{await this.initializeServices(),this.windowManager.createMainWindow(),this.setupIPCHandlers(),console.log("Matrix AI Workflow 应用启动成功")}catch(e){console.error("应用启动失败:",e),s.app.quit()}}async initializeServices(){await this.projectManager.initialize(),await this.assetManager.initialize(),console.log("服务初始化完成（暂时跳过未创建的服务）")}setupIPCHandlers(){s.ipcMain.handle("app:version",()=>s.app.getVersion()),s.ipcMain.handle("app:quit",()=>s.app.quit()),s.ipcMain.handle("app:restart",()=>{s.app.relaunch(),s.app.exit()}),s.ipcMain.handle("window:minimize",()=>{const e=s.BrowserWindow.getFocusedWindow();e&&e.minimize()}),s.ipcMain.handle("window:maximize",()=>{const e=s.BrowserWindow.getFocusedWindow();e&&(e.isMaximized()?e.unmaximize():e.maximize())}),s.ipcMain.handle("window:close",()=>{const e=s.BrowserWindow.getFocusedWindow();e&&e.close()}),s.ipcMain.handle("window:isMaximized",()=>{const e=s.BrowserWindow.getFocusedWindow();return!!e&&e.isMaximized()}),s.ipcMain.handle("project:create",(e,t,i)=>this.projectManager.createProject(t,i)),s.ipcMain.handle("project:load",(e,t)=>this.projectManager.loadProject(t)),s.ipcMain.handle("project:save",(e,t,i)=>this.projectManager.saveProject(t,i)),s.ipcMain.handle("project:delete",(e,t)=>this.projectManager.deleteProject(t)),s.ipcMain.handle("project:list",()=>this.projectManager.listProjects()),s.ipcMain.handle("asset:add",(e,t,i,s)=>this.assetManager.addAsset({scope:t,id:i},s)),s.ipcMain.handle("asset:remove",(e,t,i,s)=>this.assetManager.removeAsset(t,i,s)),s.ipcMain.handle("asset:update",(e,t,i,s,a)=>this.assetManager.updateAsset(t,i,s,a)),s.ipcMain.handle("asset:search",(e,t,i,s)=>this.assetManager.searchAssets(t,i,s)),s.ipcMain.handle("asset:preview",(e,t,i,s)=>this.assetManager.getAssetPreview(t,i,s)),s.ipcMain.handle("workflow:execute",(e,t)=>Promise.resolve(`模拟执行工作流: ${JSON.stringify(t)}`)),s.ipcMain.handle("workflow:status",(e,t)=>Promise.resolve({jobId:t,status:"completed",progress:100})),s.ipcMain.handle("workflow:cancel",(e,t)=>Promise.resolve(`取消工作流: ${t}`)),s.ipcMain.handle("workflow:list",()=>Promise.resolve([{id:"workflow1",name:"默认工作流",type:"comfyui"},{id:"workflow2",name:"视频生成",type:"n8n"}])),s.ipcMain.handle("workflow:save",(e,t,i)=>Promise.resolve(`保存工作流: ${t}`)),s.ipcMain.handle("workflow:load",(e,t)=>Promise.resolve({id:t,name:"加载的工作流",config:{}})),s.ipcMain.handle("plugin:install",(e,t)=>Promise.resolve(`安装插件: ${JSON.stringify(t)}`)),s.ipcMain.handle("plugin:uninstall",(e,t)=>Promise.resolve(`卸载插件: ${t}`)),s.ipcMain.handle("plugin:load",(e,t)=>Promise.resolve({id:t,name:"加载的插件",isEnabled:!0})),s.ipcMain.handle("plugin:execute",(e,t,i,s)=>Promise.resolve(`执行插件动作: ${t}.${i}(${JSON.stringify(s)})`)),s.ipcMain.handle("plugin:list",()=>Promise.resolve([{id:"plugin1",name:"OpenAI插件",type:"official",isEnabled:!0},{id:"plugin2",name:"社区插件",type:"community",isEnabled:!1}])),s.ipcMain.handle("task:create",(e,t)=>{const i=`task_${Date.now()}`;return Promise.resolve(i)}),s.ipcMain.handle("task:execute",(e,t,i)=>{const s=`exec_${Date.now()}`;return Promise.resolve(s)}),s.ipcMain.handle("task:status",(e,t)=>Promise.resolve({executionId:t,status:"running",progress:50})),s.ipcMain.handle("task:cancel",(e,t)=>Promise.resolve(`取消任务: ${t}`)),s.ipcMain.handle("task:results",(e,t)=>Promise.resolve({executionId:t,results:{output:"模拟结果"}})),s.ipcMain.handle("api:call",(e,t,i)=>Promise.resolve(`调用API: ${t}(${JSON.stringify(i)})`)),s.ipcMain.handle("api:set-key",(e,t,i)=>Promise.resolve(`设置API密钥: ${t}`)),s.ipcMain.handle("api:get-status",(e,t)=>Promise.resolve({name:t,status:"available",lastChecked:(new Date).toISOString()})),s.ipcMain.handle("api:get-usage",(e,t)=>Promise.resolve({name:t,usage:{requests:100,cost:.5}})),s.ipcMain.handle("file:read",async(e,t)=>{try{const e=i(896).promises;return{success:!0,content:await e.readFile(t,"utf-8")}}catch(e){return{success:!1,error:e instanceof Error?e.message:String(e)}}}),s.ipcMain.handle("file:write",async(e,t,s)=>{try{const e=i(896).promises;return await e.writeFile(t,s,"utf-8"),{success:!0}}catch(e){return{success:!1,error:e instanceof Error?e.message:String(e)}}}),s.ipcMain.handle("file:delete",async(e,t)=>{try{const e=i(896).promises;return await e.unlink(t),{success:!0}}catch(e){return{success:!1,error:e instanceof Error?e.message:String(e)}}}),s.ipcMain.handle("file:exists",async(e,t)=>{try{const e=i(896).promises;return await e.access(t),!0}catch{return!1}}),s.ipcMain.handle("file:list",async(e,t)=>{try{const e=i(896).promises;return(await e.readdir(t,{withFileTypes:!0})).map(e=>(console.log("[DEBUG] Processing file item:",e.name,"isDirectory:",e.isDirectory(),"isFile:",e.isFile()),{name:e.name,isDirectory:e.isDirectory(),isFile:e.isFile()}))}catch(e){return[]}}),s.ipcMain.handle("file:watch",async(e,t)=>Promise.resolve(`监视文件: ${t}`)),s.ipcMain.handle("file:unwatch",async(e,t)=>Promise.resolve(`取消监视文件: ${t}`)),s.ipcMain.handle("mcp:connect",(e,t)=>Promise.resolve(`连接MCP服务: ${JSON.stringify(t)}`)),s.ipcMain.handle("mcp:disconnect",(e,t)=>Promise.resolve(`断开MCP服务: ${t}`)),s.ipcMain.handle("mcp:call",(e,t,i,s)=>Promise.resolve(`调用MCP服务: ${t}.${i}(${JSON.stringify(s)})`)),s.ipcMain.handle("mcp:status",(e,t)=>Promise.resolve({serviceId:t,status:"connected"})),s.ipcMain.handle("mcp:list",()=>Promise.resolve([{id:"mcp1",name:"文件系统MCP",status:"connected"},{id:"mcp2",name:"时间服务MCP",status:"connected"}])),s.ipcMain.handle("local:start",(e,t,i)=>Promise.resolve(`启动本地服务: ${t}`)),s.ipcMain.handle("local:stop",(e,t)=>Promise.resolve(`停止本地服务: ${t}`)),s.ipcMain.handle("local:status",(e,t)=>Promise.resolve({serviceId:t,status:"running"})),s.ipcMain.handle("local:restart",(e,t)=>Promise.resolve(`重启本地服务: ${t}`)),console.log("IPC处理器设置完成")}async cleanup(){try{await this.projectManager.cleanup(),await this.assetManager.cleanup(),console.log("应用清理完成（暂时跳过未创建的服务）")}catch(e){console.error("应用清理失败:",e)}}}})();